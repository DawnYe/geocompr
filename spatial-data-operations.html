<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Geocomputation with R</title>
  <meta name="description" content="Forthcoming book on geographic data with R.">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="Geocomputation with R" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="http://robinlovelace.net/geocompr" />
  
  <meta property="og:description" content="Forthcoming book on geographic data with R." />
  <meta name="github-repo" content="Robinlovelace/geocompr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Geocomputation with R" />
  
  <meta name="twitter:description" content="Forthcoming book on geographic data with R." />
  

<meta name="author" content="Robin Lovelace, Jakub Nowosad, Jannes Muenchow">


<meta name="date" content="2017-10-29">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="attr.html">
<link rel="next" href="read-write.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-0.9/htmlwidgets.js"></script>
<link href="libs/leaflet-0.7.7/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-0.7.7/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<link href="libs/leaflet-label-0.2.2/leaflet.label.css" rel="stylesheet" />
<script src="libs/leaflet-label-0.2.2/leaflet.label.js"></script>
<script src="libs/Proj4Leaflet-0.7.2/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-0.7.2/proj4leaflet.js"></script>
<script src="libs/leaflet-binding-1.1.0/leaflet.js"></script>
<script src="libs/leaflet-providers-1.0.27/leaflet-providers.js"></script>
<script src="libs/leaflet-providers-plugin-1.1.0/leaflet-providers-plugin.js"></script>
<link href="libs/leaflet-awesomemarkers-2.0.3/leaflet.awesome-markers.css" rel="stylesheet" />
<script src="libs/leaflet-awesomemarkers-2.0.3/leaflet.awesome-markers.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99618359-1', 'auto');
  ga('send', 'pageview');

</script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Geocomputation with R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#development"><i class="fa fa-check"></i>Development</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#reproducibility"><i class="fa fa-check"></i>Reproducibility</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#what-is-geocomputation"><i class="fa fa-check"></i><b>1.1</b> What is geocomputation?</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#why-geocomputation-with-r"><i class="fa fa-check"></i><b>1.2</b> Why Geocomputation with R?</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#software-for-geocomputation"><i class="fa fa-check"></i><b>1.3</b> Software for geocomputation</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#rs-spatial-ecosystem"><i class="fa fa-check"></i><b>1.4</b> R’s spatial ecosystem</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#the-history-of-r-spatial"><i class="fa fa-check"></i><b>1.5</b> The history of R-spatial</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="spatial-class.html"><a href="spatial-class.html"><i class="fa fa-check"></i><b>2</b> Geographic data in R</a><ul>
<li class="chapter" data-level="" data-path="spatial-class.html"><a href="spatial-class.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="2.1" data-path="spatial-class.html"><a href="spatial-class.html#vector-data"><i class="fa fa-check"></i><b>2.1</b> Vector data</a><ul>
<li class="chapter" data-level="2.1.1" data-path="spatial-class.html"><a href="spatial-class.html#intro-sf"><i class="fa fa-check"></i><b>2.1.1</b> An introduction to simple features</a></li>
<li class="chapter" data-level="2.1.2" data-path="spatial-class.html"><a href="spatial-class.html#why-simple-features"><i class="fa fa-check"></i><b>2.1.2</b> Why simple features?</a></li>
<li class="chapter" data-level="2.1.3" data-path="spatial-class.html"><a href="spatial-class.html#basic-map"><i class="fa fa-check"></i><b>2.1.3</b> Basic map making</a></li>
<li class="chapter" data-level="2.1.4" data-path="spatial-class.html"><a href="spatial-class.html#base-args"><i class="fa fa-check"></i><b>2.1.4</b> Base plot arguments</a></li>
<li class="chapter" data-level="2.1.5" data-path="spatial-class.html"><a href="spatial-class.html#sf-classes"><i class="fa fa-check"></i><b>2.1.5</b> Simple feature classes</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="spatial-class.html"><a href="spatial-class.html#raster-data"><i class="fa fa-check"></i><b>2.2</b> Raster data</a><ul>
<li class="chapter" data-level="2.2.1" data-path="spatial-class.html"><a href="spatial-class.html#an-introduction-to-raster"><i class="fa fa-check"></i><b>2.2.1</b> An introduction to raster</a></li>
<li class="chapter" data-level="2.2.2" data-path="spatial-class.html"><a href="spatial-class.html#basic-map-making"><i class="fa fa-check"></i><b>2.2.2</b> Basic map making</a></li>
<li class="chapter" data-level="2.2.3" data-path="spatial-class.html"><a href="spatial-class.html#raster-classes"><i class="fa fa-check"></i><b>2.2.3</b> Raster classes</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="spatial-class.html"><a href="spatial-class.html#crs-intro"><i class="fa fa-check"></i><b>2.3</b> Coordinate Reference Systems</a><ul>
<li class="chapter" data-level="2.3.1" data-path="spatial-class.html"><a href="spatial-class.html#geographic-coordinate-systems"><i class="fa fa-check"></i><b>2.3.1</b> Geographic coordinate systems</a></li>
<li class="chapter" data-level="2.3.2" data-path="spatial-class.html"><a href="spatial-class.html#projected-coordinate-systems"><i class="fa fa-check"></i><b>2.3.2</b> Projected coordinate systems</a></li>
<li class="chapter" data-level="2.3.3" data-path="spatial-class.html"><a href="spatial-class.html#crs-in-r"><i class="fa fa-check"></i><b>2.3.3</b> CRS in R</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="spatial-class.html"><a href="spatial-class.html#units"><i class="fa fa-check"></i><b>2.4</b> Units</a></li>
<li class="chapter" data-level="2.5" data-path="spatial-class.html"><a href="spatial-class.html#ex2"><i class="fa fa-check"></i><b>2.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="attr.html"><a href="attr.html"><i class="fa fa-check"></i><b>3</b> Attribute data operations</a><ul>
<li class="chapter" data-level="" data-path="attr.html"><a href="attr.html#prerequisites-1"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="3.1" data-path="attr.html"><a href="attr.html#introduction"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="attr.html"><a href="attr.html#vector-attribute-manipulation"><i class="fa fa-check"></i><b>3.2</b> Vector attribute manipulation</a><ul>
<li class="chapter" data-level="3.2.1" data-path="attr.html"><a href="attr.html#vector-attribute-subsetting"><i class="fa fa-check"></i><b>3.2.1</b> Vector attribute subsetting</a></li>
<li class="chapter" data-level="3.2.2" data-path="attr.html"><a href="attr.html#vector-attribute-aggregation"><i class="fa fa-check"></i><b>3.2.2</b> Vector attribute aggregation</a></li>
<li class="chapter" data-level="3.2.3" data-path="attr.html"><a href="attr.html#vector-attribute-joining"><i class="fa fa-check"></i><b>3.2.3</b> Vector attribute joining</a></li>
<li class="chapter" data-level="3.2.4" data-path="attr.html"><a href="attr.html#creating-attributes-and-removing-spatial-information"><i class="fa fa-check"></i><b>3.2.4</b> Creating attributes and removing spatial information</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="attr.html"><a href="attr.html#manipulating-raster-objects"><i class="fa fa-check"></i><b>3.3</b> Manipulating raster objects</a><ul>
<li class="chapter" data-level="3.3.1" data-path="attr.html"><a href="attr.html#raster-subsetting"><i class="fa fa-check"></i><b>3.3.1</b> Raster subsetting</a></li>
<li class="chapter" data-level="3.3.2" data-path="attr.html"><a href="attr.html#summarizing-raster-objects"><i class="fa fa-check"></i><b>3.3.2</b> Summarizing raster objects</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="attr.html"><a href="attr.html#exercises-1"><i class="fa fa-check"></i><b>3.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html"><i class="fa fa-check"></i><b>4</b> Spatial data operations</a><ul>
<li class="chapter" data-level="" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#prerequisites-2"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="4.1" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#introduction-1"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#spatial-operations-on-vector-data"><i class="fa fa-check"></i><b>4.2</b> Spatial operations on vector data</a><ul>
<li class="chapter" data-level="4.2.1" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#spatial-subsetting"><i class="fa fa-check"></i><b>4.2.1</b> Spatial subsetting</a></li>
<li class="chapter" data-level="4.2.2" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#topological-relations"><i class="fa fa-check"></i><b>4.2.2</b> Topological relations</a></li>
<li class="chapter" data-level="4.2.3" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#spatial-joining-and-aggregation"><i class="fa fa-check"></i><b>4.2.3</b> Spatial joining and aggregation</a></li>
<li class="chapter" data-level="4.2.4" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#non-overlapping-joins"><i class="fa fa-check"></i><b>4.2.4</b> Non-overlapping joins</a></li>
<li class="chapter" data-level="4.2.5" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#aggregating-or-dissolving"><i class="fa fa-check"></i><b>4.2.5</b> Aggregating or dissolving</a></li>
<li class="chapter" data-level="4.2.6" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#modifying-geometry-data"><i class="fa fa-check"></i><b>4.2.6</b> Modifying geometry data</a></li>
<li class="chapter" data-level="4.2.7" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#clipping"><i class="fa fa-check"></i><b>4.2.7</b> Clipping</a></li>
<li class="chapter" data-level="4.2.8" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#distance-relations"><i class="fa fa-check"></i><b>4.2.8</b> Distance relations</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#spatial-operations-on-raster-data"><i class="fa fa-check"></i><b>4.3</b> Spatial operations on raster data</a><ul>
<li class="chapter" data-level="4.3.1" data-path="attr.html"><a href="attr.html#raster-subsetting"><i class="fa fa-check"></i><b>4.3.1</b> Spatial subsetting</a></li>
<li class="chapter" data-level="4.3.2" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#map-algebra"><i class="fa fa-check"></i><b>4.3.2</b> Map algebra</a></li>
<li class="chapter" data-level="4.3.3" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#local-operations"><i class="fa fa-check"></i><b>4.3.3</b> Local operations</a></li>
<li class="chapter" data-level="4.3.4" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#focal-operations"><i class="fa fa-check"></i><b>4.3.4</b> Focal operations</a></li>
<li class="chapter" data-level="4.3.5" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#zonal-operations"><i class="fa fa-check"></i><b>4.3.5</b> Zonal operations</a></li>
<li class="chapter" data-level="4.3.6" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#global-operations-and-distances"><i class="fa fa-check"></i><b>4.3.6</b> Global operations and distances</a></li>
<li class="chapter" data-level="4.3.7" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#merging-rasters"><i class="fa fa-check"></i><b>4.3.7</b> Merging rasters</a></li>
<li class="chapter" data-level="4.3.8" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#aligning-rasters"><i class="fa fa-check"></i><b>4.3.8</b> Aligning rasters</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#exercises-2"><i class="fa fa-check"></i><b>4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="read-write.html"><a href="read-write.html"><i class="fa fa-check"></i><b>5</b> Geographic data I/O</a><ul>
<li class="chapter" data-level="" data-path="read-write.html"><a href="read-write.html#prerequisites-3"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="5.1" data-path="read-write.html"><a href="read-write.html#introduction-2"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="read-write.html"><a href="read-write.html#retrieving-data"><i class="fa fa-check"></i><b>5.2</b> Retrieving open data</a></li>
<li class="chapter" data-level="5.3" data-path="read-write.html"><a href="read-write.html#file-formats"><i class="fa fa-check"></i><b>5.3</b> File formats</a></li>
<li class="chapter" data-level="5.4" data-path="read-write.html"><a href="read-write.html#data-input"><i class="fa fa-check"></i><b>5.4</b> Data Input (I)</a><ul>
<li class="chapter" data-level="5.4.1" data-path="read-write.html"><a href="read-write.html#vector-data-1"><i class="fa fa-check"></i><b>5.4.1</b> Vector data</a></li>
<li class="chapter" data-level="5.4.2" data-path="read-write.html"><a href="read-write.html#raster-data-1"><i class="fa fa-check"></i><b>5.4.2</b> Raster data</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="read-write.html"><a href="read-write.html#data-output"><i class="fa fa-check"></i><b>5.5</b> Data output (O)</a><ul>
<li class="chapter" data-level="5.5.1" data-path="read-write.html"><a href="read-write.html#vector-data-2"><i class="fa fa-check"></i><b>5.5.1</b> Vector data</a></li>
<li class="chapter" data-level="5.5.2" data-path="read-write.html"><a href="read-write.html#raster-data-2"><i class="fa fa-check"></i><b>5.5.2</b> Raster data</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="read-write.html"><a href="read-write.html#visual-outputs"><i class="fa fa-check"></i><b>5.6</b> Visual outputs</a></li>
<li class="chapter" data-level="5.7" data-path="read-write.html"><a href="read-write.html#exercises-3"><i class="fa fa-check"></i><b>5.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="transform.html"><a href="transform.html"><i class="fa fa-check"></i><b>6</b> Reprojections and Transformations</a><ul>
<li class="chapter" data-level="" data-path="transform.html"><a href="transform.html#prerequisites-4"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="6.1" data-path="transform.html"><a href="transform.html#introduction-3"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="transform.html"><a href="transform.html#crs-transformation"><i class="fa fa-check"></i><b>6.2</b> CRS transformation</a><ul>
<li class="chapter" data-level="6.2.1" data-path="transform.html"><a href="transform.html#vector-data-3"><i class="fa fa-check"></i><b>6.2.1</b> Vector data</a></li>
<li class="chapter" data-level="6.2.2" data-path="transform.html"><a href="transform.html#raster-data-3"><i class="fa fa-check"></i><b>6.2.2</b> Raster data</a></li>
<li class="chapter" data-level="6.2.3" data-path="transform.html"><a href="transform.html#exercises-4"><i class="fa fa-check"></i><b>6.2.3</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>7</b> References</a></li>
<li class="divider"></li>
<li><a href="http://robinlovelace.net/">Robin Lovelace</a></li>
<li><a href="https://nowosad.github.io/">Jakub Nowosad</a></li>
<li><a href="http://www.geographie.uni-jena.de/en/Muenchow.html">Jannes Muenchow</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Geocomputation with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatial-data-operations" class="section level1">
<h1><span class="header-section-number">4</span> Spatial data operations</h1>
<div id="prerequisites-2" class="section level2 unnumbered">
<h2>Prerequisites</h2>
<ul>
<li>This chapter requires the packages <strong>tidyverse</strong>, <strong>sf</strong> and <strong>raster</strong>.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sf)
<span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(raster)</code></pre></div>
<ul>
<li>It also relies on <strong>spData</strong>, which loads datasets used in examples in the chapter:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(spData)</code></pre></div>
</div>
<div id="introduction-1" class="section level2">
<h2><span class="header-section-number">4.1</span> Introduction</h2>
<p>Spatial operations are a vital part of geocomputation. This chapter shows how spatial objects can be modified in a multitude of ways based on their location and shape. The content clearly builds on the previous chapter because many spatial operations have a non-spatial (attribute) equivalent. Spatial operations on <em>vector</em> objects include spatial subsetting (covered in section <a href="spatial-data-operations.html#spatial-subsetting">4.2.1</a>), joining and aggregation (section <a href="spatial-data-operations.html#spatial-joining-and-aggregation">4.2.3</a>). These topics may sound daunting, but they have already been covered, in section <a href="attr.html#vector-attribute-manipulation">3.2</a>. Spatial operations on <em>rasters</em> include merging and subsetting, covered in section <a href="spatial-data-operations.html#spatial-operations-on-raster-data">4.3</a>.</p>
<p>The chapter also introduces new concepts that are unique to spatial data. A variety of <em>topological relations</em> can be used to subset/join vector geometries (by default <strong>sf</strong> uses the catch-all <em>intersects</em> but other relations such as <em>within</em> can be very useful), a topic that is explored in section <a href="spatial-data-operations.html#topological-relations">4.2.2</a>. New geometry data can be created by modifying existing spatial objects, using operations such as ‘buffer’ and ‘clip’, described in sections <a href="spatial-data-operations.html#modifying-geometry-data">4.2.6</a> and <a href="spatial-data-operations.html#clipping">4.2.7</a>. Spatial operations on raster datasets involve <em>map algebra</em> (covered in sections <a href="spatial-data-operations.html#map-algebra">4.3.2</a> to <a href="spatial-data-operations.html#global-operations-and-distances">4.3.6</a>) and combining and aligning them (covered in sections <a href="spatial-data-operations.html#merging-rasters">4.3.7</a> and <a href="spatial-data-operations.html#aligning-rasters">4.3.8</a>).</p>
<p>Another unique aspect of spatial objects is distance. All spatial objects are related through space and distance calculations can be used to find the strength of this relationship between spatial entities. Distance operations are covered in sections <a href="spatial-data-operations.html#distance-relations">4.2.8</a> and <a href="spatial-data-operations.html#global-operations-and-distances">4.3.6</a> for vector and raster datasets respectively.</p>

<div class="rmdnote">
It is important to note that spatial operations that use two spatial objects rely on both objects having the same coordinate reference system, a topic that was introduced in <a href="spatial-class.html#crs-intro">2.3</a> and which will be covered in more depth in Chapter 6.
</div>
<p></p>
</div>
<div id="spatial-operations-on-vector-data" class="section level2">
<h2><span class="header-section-number">4.2</span> Spatial operations on vector data</h2>
<p>This section provides an overview of spatial operations in the <strong>sf</strong> package.</p>
<div id="spatial-subsetting" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Spatial subsetting</h3>
<p>Spatial subsetting is the process of selecting features of a spatial object based on whether or not they in some way <em>relate</em> in space to another object. An example of spatial subsetting is provided by the <code>nz</code> and <code>nz_height</code> datasets in <strong>spData</strong>, which provide projected data on the 16 main regions and 101 highest points in New Zealand (Figure <a href="spatial-data-operations.html#fig:nz-subset">4.1</a>). The following code subsets all the high points in the Canterbury region:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">canterbury =<span class="st"> </span>nz %&gt;%<span class="st"> </span><span class="kw">filter</span>(REGC2017_NAME ==<span class="st"> &quot;Canterbury Region&quot;</span>)
canterbury_height =<span class="st"> </span>nz_height[canterbury, ]</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:nz-subset"></span>
<img src="figures/nz-subset-1.png" alt="Illustration of spatial subsetting. The right-hand map was produced by subsetting the point data in the left hand map as follows: `nz_height[canterbury, ]`." width="576" />
<p class="caption">
Figure 4.1: Illustration of spatial subsetting. The right-hand map was produced by subsetting the point data in the left hand map as follows: <code>nz_height[canterbury, ]</code>.
</p>
</div>
<p>The preceding code chunk shows that, like attribute data, spatial data can be subset using the <code>[</code> operator: <code>x[y, ]</code> subsets features of target object <code>x</code> by <code>y</code>. Instead of <code>y</code> being of class <code>logical</code> (a vector of <code>TRUE</code> and <code>FALSE</code> values), it is another spatial (<code>sf</code>) object.</p>
<p>Various <em>topological relations</em>, which determine the type of spatial relationship used for subsetting, can be used for spatial subsetting. As we’ll see in section <a href="spatial-data-operations.html#topological-relations">4.2.2</a>, these include features that <em>touch</em>, <em>cross</em> or are <em>within</em> the source object (<code>y</code>). <em>Intersects</em> is the default for subsetting (and other spatial operations) however, because it is a useful ‘catch all’ that identifies all types of spatial relations. Topological relations are best understood in the context of subsetting, explaining why this topic is covered in the next section.</p>
<p>For now the important thing to remember is that subsetting a spatial object <code>x</code> by another spatial object <code>y</code> returns any features in <code>x</code> that in some way relate (using the <em>intersects</em> operator) in space to <code>y</code>. Other operators can be used using the <code>op =</code> argument. The following code, for example, would select all points in <code>nz_height</code> that do <em>not</em> intersect with Canterbury (result not shown):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nz_height[canterbury, , op =<span class="st"> </span>st_disjoint]</code></pre></div>

<div class="rmdnote">
Interested readers can see this default value of <code>op</code> set in the first line of the function call by entering its long-form name into the console <code>sf:::`[.sf`</code>. The <code>?sf</code> help page documents this also.
</div>
<p></p>
<p>In general terms, spatial subsetting is simply the spatial equivalent of <em>attribute subsetting</em>. As with attribute subsetting, spatial subsetting is a <em>binary operation</em>: an object is either selected or not. Following the structure of section <a href="attr.html#vector-attribute-subsetting">3.2.1</a>, we start with base methods before describing how to do it in the <strong>tidyverse</strong>. <!-- todo: link to non-binary links, e.g. area-weighted spatial interpolation --></p>
<!-- #### Spatial subsetting in base R -->
<p>Another spatial subsetting example will use an object representing the countries of Africa, created using attribute subsetting as follows:</p>
<p>We will apply attribute subsetting to the <code>world</code> dataset (see previous chapter):<a href="#fn18" class="footnoteRef" id="fnref18"><sup>18</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">africa_wgs =<span class="st"> </span>world %&gt;%<span class="st"> </span><span class="kw">filter</span>(continent ==<span class="st"> &quot;Africa&quot;</span>)</code></pre></div>
<p>To further prepare the input data, we will reproject the data to the coordinate reference system (CRS) 32630, its EPSG code (explained in Chapter 6):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">africa =<span class="st"> </span><span class="kw">st_transform</span>(africa_wgs, <span class="dt">crs =</span> <span class="dv">32630</span>)</code></pre></div>
<p>We can also use the <code>[</code> operator for <em>Spatial</em> subsetting. The difference is that we use <em>another spatial object</em> inside the square brackets instead of an <code>integer</code> or <code>logical</code> vector. This is a concise and consistent syntax, as shown in the next code chunk. Let’s test it with a hypothetical scenario: we want to subset all countries within 2000 km of the point where the equator (where latitude = 0 degrees) intersects the prime meridian (longitude = 0 degrees), as illustrated in Figure <a href="spatial-data-operations.html#fig:globe">4.2</a>. The subsetting object is created below. Note that this must have the same CRS as the target object (set with the <code>crs</code> argument):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">center_wgs =<span class="st"> </span><span class="kw">st_sf</span>(<span class="dt">geometry =</span> <span class="kw">st_sfc</span>(<span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)), <span class="dt">crs =</span> <span class="dv">4326</span>))
center =<span class="st"> </span><span class="kw">st_transform</span>(center_wgs, <span class="dv">32630</span>)
buff =<span class="st"> </span><span class="kw">st_buffer</span>(center, <span class="dt">dist =</span> <span class="fl">2e6</span>)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:globe"></span>
<img src="figures/globe.png" alt="Subsetting scenario: which countries intersect with a circle of 2000 km in radius located at zero degrees longitude and zero degrees latitude? Figure created with the **[globe](https://cran.r-project.org/package=globe)** package." width="250" />
<p class="caption">
Figure 4.2: Subsetting scenario: which countries intersect with a circle of 2000 km in radius located at zero degrees longitude and zero degrees latitude? Figure created with the <strong><a href="https://cran.r-project.org/package=globe">globe</a></strong> package.
</p>
</div>
<p>The data to be subset, or ‘target layer’, is the <code>africa</code> object created above, which has a projected CRS (<code>32630</code>). Subsequently, spatial subsetting can be done with a single, concise command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">africa_buf =<span class="st"> </span>africa[buff, ]</code></pre></div>

<div class="rmdnote">
If we were using geographic (‘lon/lat’) data the previous command would have emitted a message warning about assuming <code>planar coordinates</code>. This is because spatial operations (especially distance and area calculations) cannot be assumed to be accurate in a geographic (longitude/latitude) CRS. In this case one could justify the use of a lon/lat CRS: the data is close to the equator where there is least distortion caused by the curvature of the earth. It is good practice to reproject spatial datasets before performing spatial operations on them.
</div>
<p></p>
<p>The spatial subsetting clearly worked: only countries intersecting with the giant circle are returned (Figure <a href="spatial-data-operations.html#fig:africa-buff">4.3</a>):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(africa_buf[<span class="st">&quot;pop&quot;</span>])
<span class="kw">plot</span>(buff, <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<!-- Todo: improve this figure, e.g. by creating a new hidden chunk - still show this one -->
<div class="figure" style="text-align: center"><span id="fig:africa-buff"></span>
<div id="htmlwidget-ec897849c5c50a6f7846" style="width:576px;height:355.968px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-ec897849c5c50a6f7846">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addProviderTiles","args":["OpenMapSurfer.Grayscale",null,null,{"errorTileUrl":"","noWrap":false,"zIndex":null,"unloadInvisibleTiles":null,"updateWhenIdle":null,"detectRetina":false,"reuseTiles":false}]},{"method":"addPolygons","args":[[[[{"lng":[16.3264946366222,16.5731427925991,16.8601490891004,17.0899499967591,17.472916159755,18.1341501940603,18.4640935289186,19.0166489012368,19.1665038524772,19.4173806726724,20.0375675595486,20.0914625789608,20.601629635549,20.5145616001362,21.7278170559078,21.7461607824271,21.9488132134435,21.8015006694381,21.874872889144,22.2084034615342,22.1549231576025,22.4024203353371,22.8369020500225,23.4562373231583,23.911564320954,24.0172151747887,23.90349735334,24.0792010515247,23.9302494726319,24.0154381101598,21.9335628837241,21.8875009511032,22.56202042102,23.214444012824,21.376878032368,18.956081328066,18.2632332470237,14.2096968372698,14.0584923958876,13.4623556833726,12.814076886438,12.2154584515512,11.7341966453805,11.6400939594282,11.7785348620309,12.1235777437979,12.1756157666587,12.5000912887483,12.7384740217431,13.3129073590127,13.633713311415,13.7387191819626,13.6863710394316,13.387320667975,13.120981164649,12.8753637567469,12.9290553596331,13.2364256325215,12.9330341632959,12.7282926675832,12.2273426011564,12.3224269759198,12.7351654582441,13.0248625740497,13.3755891355532,16.3264946366222],"lat":[-5.87746944900787,-6.62264347279008,-7.22229668127161,-7.54568772716805,-8.06854978837497,-7.98767610979167,-7.84701285988062,-7.98824466046554,-7.73818241592074,-7.15542730056164,-7.11636025901458,-6.94308918191948,-6.93931730682019,-7.29960542752825,-7.29087462367786,-7.92008762646592,-8.30590519624488,-8.90871105026306,-9.5237136814915,-9.89480494107764,-11.0848124697594,-10.993088682721,-11.0176395691648,-10.8678889301145,-10.9268599716907,-11.2373361363889,-11.7223202884278,-12.1913430755659,-12.5658930097304,-12.9110964491783,-12.8984519609473,-16.0803362668205,-16.8984941411822,-17.5231809857434,-17.9306627175272,-17.7891004363932,-17.3099538146413,-17.3531003655766,-17.4233803155034,-16.9712115119331,-16.9413425709637,-17.1116681391584,-17.3018891242384,-16.6731419701768,-15.7938157757126,-14.878316057146,-14.4491432763707,-13.5476995441467,-13.1379054011293,-12.4836300013553,-12.0386441855614,-11.2978625045045,-10.7310754043458,-10.373577901586,-9.76689663843128,-9.16693330790977,-8.959090692771,-8.56262906347772,-7.59653823441391,-6.92712177829469,-6.29444729398377,-6.10009222790462,-5.96568178641284,-5.98438861863779,-5.86424087144026,-5.87746944900787]}],[{"lng":[12.4366832137461,12.1823324750018,11.9149591381589,12.3186027543647,12.6207539842476,12.9955102759003,12.6316060692363,12.4679989906227,12.4366832137461],"lat":[-5.68430365487565,-5.78993030425892,-5.03798658244754,-4.60622997195686,-4.43802316522506,-4.78110294769541,-4.99127102646683,-5.24836128369489,-5.68430365487565]}]],[[{"lng":[2.69170169083768,1.86524051133857,1.61895063543497,1.66447757238747,1.46304283952157,1.42506066184709,1.07779503708127,0.772335645939571,0.899563022211253,1.24346967896207,1.44717817496006,1.93598554760191,2.15447350311454,2.49016360683249,2.84864301689066,3.61118044857085,3.57221641859328,3.79711225002037,3.60007001471975,3.70543825924766,3.2203515918667,2.91230838019662,2.72379275568772,2.74906253082819,2.69170169083768],"lat":[6.25881724670379,6.14215770095267,6.83203807206634,9.12859039952839,9.33462433509547,9.82539541257242,10.1756065942385,10.4708082137198,10.9973393823353,11.110510769033,11.5477192244184,11.6411502139318,11.9401500511225,12.2330520692484,12.2356358907069,11.6601671401506,11.3279393570036,10.7347455905203,10.3321861832014,10.0632103530351,9.4441525328256,9.13760793664795,8.50684540418851,7.87073436090112,6.25881724670379]}]],[[{"lng":[-2.82749630371271,-3.51189897298626,-3.98044918457645,-4.33024695475927,-4.77988359212717,-4.95465328613555,-5.40434159992548,-5.47056494790555,-5.19784257649633,-5.22094194173057,-4.42716610352258,-4.28040503581422,-4.00639075358704,-3.52280270019985,-3.10370683431276,-2.96769446452058,-2.19182451009044,-2.00103512206893,-1.0663634912097,-0.515854458014002,-0.266257290053413,0.374892205348796,0.295646396430651,0.429927605719306,0.993045688274056,1.02410322405366,2.1771077805443,2.15447350311454,1.93598554760191,1.44717817496006,1.24346967896207,0.899563022211253,0.023802524356833,-0.438701544616443,-0.761575893562303,-1.20335771321599,-2.94040930827046,-2.96389624674711,-2.82749630371271],"lat":[9.64246084231978,9.90032623945622,9.86234406172169,9.61083486575711,9.82198476810155,10.1527139347694,10.3707368026078,10.9512698429744,11.3751457788493,11.7138589543063,12.5426455754042,13.2284435083497,13.4724854598481,13.3376616479986,13.5412667912286,13.7981503361515,14.2464175480674,14.5590082870009,14.9738150090073,15.1161577417536,14.9243089868683,14.9289081893316,14.4442349308685,13.9887330184286,13.3357496199649,12.8518256697668,12.6250178082735,11.9401500511225,11.6411502139318,11.5477192244184,11.110510769033,10.9973393823353,11.0186817488951,11.0983409692767,10.9369296330142,11.0098192407625,10.9626903345126,10.3953347843801,9.64246084231978]}]],[[{"lng":[15.2794402394352,16.1062020608689,16.2905294616858,16.4561499245877,16.7059495574911,17.9648630345624,18.3894756842399,18.9109239067972,18.8119160976054,19.0939030014518,20.0595308103562,21.0006459751457,21.7235289055143,22.2307745634121,22.8637172364704,22.9770783085263,23.5537354203027,23.5566821150912,23.3942442926055,23.4584666826835,23.8051978565046,24.5665723054965,25.1139781916376,25.1231754668773,25.7954617687296,26.212066411619,26.4644500872456,27.2115724371058,27.3723003966314,27.0423259236246,26.4013352077355,25.6493314518938,25.27780138949,25.1278840047772,24.8041745886967,24.4097807859815,23.2966982293632,22.8410389404121,22.7037034878557,22.4047447466512,21.658832454172,20.9273691298339,20.2905046758259,19.4676569490443,18.9322096577173,18.5428939084979,18.452979573065,17.809834599116,17.1329930936567,16.5370198203329,16.0128217838909,15.9073516661242,15.8627039263166,15.4053729302134,15.0362002513085,14.950934989144,14.4783578564028,14.5589209165837,14.4593929294936,14.5365455336374,14.7765291600926,15.2794402394352],"lat":[7.4219237419954,7.49708690323585,7.75430628617177,7.73477255483915,7.50832637863817,7.89091261838612,8.2813022484466,8.63089347334287,8.98291336832349,9.0748458939695,9.01270585538665,9.47598746303741,10.5670626641293,10.9719004001583,11.1424137362959,10.7144808762176,10.0892784209639,9.68123948013189,9.26508539939521,8.95430287878513,8.66633900460827,8.22921735867453,7.825141392215,7.50012031342615,6.97936202425275,6.54665618277188,5.94677078507556,5.55102529861804,5.23401694282262,5.12791269823927,5.1509177332332,5.2561169382366,5.17043119643083,4.92726448612959,4.89726254358724,5.10879704816315,4.60969777119356,4.71012930198068,4.63305338067621,4.0291613463384,4.22434203727429,4.32278490394537,4.69167674266125,5.03152655072889,4.70950488158497,4.20178405197268,3.50438491651243,3.560195541376,3.72819570725287,3.19825409308298,2.26763929111474,2.55738901395774,3.01353681941716,3.33530014844123,3.85136683625119,4.21038882665704,4.73260504385402,5.03059715380008,5.45176006300993,6.22695815715348,6.40849740326421,7.4219237419954]}]],[[{"lng":[-2.8561250472024,-3.31108435710007,-4.0088195459046,-4.64991736491372,-5.83449622227365,-6.52876908995067,-7.51894120836481,-7.71215938843775,-7.63536821020121,-7.53971513415807,-7.57015255275824,-7.99369259119141,-8.31134761977995,-8.60288021171268,-8.38545162358773,-8.48544551987079,-8.43929846601531,-8.28070349571078,-8.22179236309123,-8.2990486292277,-8.20349890614486,-7.83210038789785,-8.0791137339716,-8.3096164598558,-8.22933712249907,-8.02994360883005,-7.89958980855816,-7.62275916105499,-6.85050655736667,-6.66646094382822,-6.4939650128835,-6.2052229475107,-6.05045203281565,-5.81692623531554,-5.40434159992548,-4.95465328613555,-4.77988359212717,-4.33024695475927,-3.98044918457645,-3.51189897298626,-2.82749630371271,-2.56218950032625,-2.98358496745033,-3.24437008301126,-2.81070146321784,-2.8561250472024],"lat":[4.99447581625951,4.98429555909802,5.17981334067431,5.16826365805701,4.99370066977319,4.70508779541759,4.3382884789829,4.36456594479208,5.18815908444142,5.31334524167375,5.70735219967822,6.12618968336007,6.19303314848148,6.46756419496373,6.91180064520027,7.39520783104124,7.68604279198493,7.68717967353084,8.1233287620791,8.31644358953437,8.45545319241766,8.57570425042122,9.37622386300662,9.78953196842041,10.1290202903768,10.2065349388565,10.2973821068481,10.1472362328641,10.1389938419711,10.4308106551297,10.4113028019445,10.5240607772111,10.0963607853498,10.2225546330087,10.3707368026078,10.1527139347694,9.82198476810155,9.61083486575711,9.86234406172169,9.90032623945622,9.64246084231978,8.21962779381148,7.37970490155551,6.2504715031135,5.38905121502411,4.99447581625951]}]],[[{"lng":[13.0758148730658,12.9513268177443,12.3593751569332,11.7516617663446,11.2764461563099,9.64915706559924,9.79519457541929,9.40436598493731,8.9481149976065,8.74492335711854,8.48881505240158,8.5002872207628,8.75753242257834,9.23316212566663,9.52270502355923,10.1182755295005,10.4973735065711,11.0587856003585,11.7457710367693,11.8393052489045,12.0639422929525,12.2188679652382,12.7536660392653,12.9554620258611,13.1675931165725,13.308669385071,13.5729417741537,14.4153669122666,14.4681800032043,14.577164958392,14.1813259614572,14.2135202868382,14.4957753229595,14.8933708646559,14.9601360723784,14.9235491968196,15.4678518561188,14.9093379373058,14.6271866661673,14.1714550859332,13.9542083834662,14.5444529149703,14.9799785647402,15.1208471445191,15.4360700825303,15.2794402394352,14.7765291600926,14.5365455336374,14.4593929294936,14.5589209165837,14.4783578564028,14.950934989144,15.0362002513085,15.4053729302134,15.8627039263166,15.9073516661242,16.0128217838909,15.9408890561445,15.1463213136243,14.3377984603732,13.0758148730658],"lat":[2.26709693970841,2.32161557967596,2.19281210703561,2.32675743840617,2.26105087190009,2.28386605021039,3.0734044099058,3.73452684779656,3.90412890562049,4.3522152506584,4.49561735352208,4.77198291193438,5.47966580583134,6.44449061766034,6.45348230765528,7.03876955075356,7.05535766564009,6.64442664658596,6.98138276235677,7.39704212822258,7.79980820997628,8.30582380728665,8.71776240831401,9.41777131703229,9.6406258935254,10.1603615809137,10.7985654687859,11.5723682126307,11.9047510224594,12.0853601387501,12.4836563205343,12.8020348240144,12.8593956214442,12.2190470194634,11.5555732684307,10.8913243988107,9.98233582602888,9.99212863499374,9.92091857387584,10.0213776541445,9.54949436241728,8.96586062299591,8.79610344757761,8.38214936533316,7.69281154816106,7.4219237419954,6.40849740326421,6.22695815715348,5.45176006300993,5.03059715380008,4.73260504385402,4.21038882665704,3.85136683625119,3.33530014844123,3.01353681941716,2.55738901395774,2.26763929111474,1.72767234503369,1.96401454324959,2.22787444504216,2.26709693970841]}]],[[{"lng":[30.8286571773564,30.7682675825456,31.1684816715193,30.8474895333333,30.4638535476947,30.0819757755952,29.8718432291345,29.8156304664184,29.5842095737655,29.5758425323866,29.2885461500198,29.251523887806,29.1142952067496,29.0218203532457,29.2730373794617,29.336562851378,29.5163385271308,29.4164289873355,29.6162272962844,30.1954570791438,30.7345764974265,30.3412444321749,28.9996454125286,28.7318467325176,28.4470687966668,28.6706530212496,28.4931193529959,28.3693323506991,28.6392200071567,29.3375183221029,29.6116444938614,29.6949508530542,28.9306169841584,28.5204050481303,28.1523407228322,27.3866436794545,27.1624443440331,26.5514568768564,25.751065081547,25.417016712106,24.7822844103741,24.3137632960087,24.2564206641067,23.911564320954,23.4562373231583,22.8369020500224,22.4024203353371,22.1549231576025,22.2084034615342,21.8748728891439,21.801500669438,21.9488132134435,21.746160782427,21.7278170559078,20.5145616001362,20.6016296355489,20.0914625789609,20.0375675595486,19.4173806726724,19.1665038524772,19.0166489012368,18.4640935289186,18.1341501940602,17.4729161597549,17.0899499967591,16.8601490891003,16.5731427925991,16.3264946366222,13.3755891355532,13.0248625740497,12.7351654582441,12.3224269759197,12.1823324750018,12.4366832137461,12.4679989906226,12.6316060692362,12.9955102759003,13.2582322682258,13.6002253244902,14.1449436501065,14.2090220936243,14.5825885332925,15.1709712749596,15.7535132481859,16.0062593231188,15.972773200448,16.4070553179944,16.8652620742655,17.5236569899604,17.6385824309057,17.663489807955,17.8264728864322,17.7741261579166,17.8987664412458,18.0942011707037,18.3937083700255,18.452979573065,18.5428939084979,18.9322096577173,19.4676569490443,20.2905046758259,20.9273691298339,21.658832454172,22.4047447466512,22.7037034878557,22.8410389404121,23.2966982293632,24.4097807859815,24.8041745886967,25.1278840047772,25.27780138949,25.6493314518938,26.4013352077355,27.0423259236246,27.3723003966314,27.9776754452038,28.4263652531494,28.6938307058949,29.1558216182772,29.7121649820839,29.9494156863389,30.8286571773564],"lat":[3.50938850173903,2.34002609833499,2.20462385313652,1.84951263766842,1.58388992636243,1.0623606833439,0.59740443170149,-0.20531838383651,-0.587426965475544,-1.34136172753148,-1.62010751994061,-2.2151798514537,-2.29227922446308,-2.8393392886474,-3.29401366641258,-4.50013651372795,-5.42018268480142,-5.94021545586691,-6.52027837926961,-7.0803516725052,-8.34057089691749,-8.23872950790845,-8.40730751546556,-8.52680927778751,-9.16516113871144,-9.60621047371614,-10.7901950648713,-11.7939832340978,-11.9719545400258,-12.3612842935529,-12.1794857879095,-13.2579187852711,-13.249465876794,-12.6990056077944,-12.2728063127055,-12.1329766660976,-11.6089417404295,-11.9245923303207,-11.7850672998142,-11.3310168453474,-11.2387510024504,-11.2628712767623,-10.9520338469715,-10.9268599716906,-10.8678889301145,-11.0176395691648,-10.993088682721,-11.0848124697594,-9.89480494107762,-9.5237136814915,-8.90871105026305,-8.30590519624485,-7.92008762646595,-7.29087462367785,-7.29960542752821,-6.93931730682019,-6.94308918191952,-7.11636025901456,-7.15542730056166,-7.73818241592077,-7.98824466046554,-7.84701285988059,-7.98767610979172,-8.06854978837502,-7.5456877271681,-7.22229668127161,-6.62264347279008,-5.87746944900792,-5.86424087144025,-5.98438861863784,-5.96568178641286,-6.10009222790462,-5.78993030425895,-5.68430365487567,-5.24836128369491,-4.99127102646683,-4.78110294769538,-4.88295716121325,-4.50013813042263,-4.51000825597937,-4.79309172218272,-4.97023845820613,-4.34350664223147,-3.8551643116507,-3.53513216690159,-2.71239181687053,-1.7409266821585,-1.22581607119338,-0.743830064112604,-0.424831526391425,-0.0580839828331749,0.288923165608205,0.855658446868776,1.74183150253962,2.36572088824896,2.90044260277509,3.50438491651243,4.20178405197268,4.70950488158497,5.03152655072889,4.69167674266125,4.32278490394537,4.22434203727429,4.0291613463384,4.63305338067621,4.71012930198068,4.60969777119356,5.10879704816315,4.89726254358724,4.92726448612959,5.17043119643083,5.2561169382366,5.1509177332332,5.12791269823927,5.23401694282262,4.40849345918767,4.28725063435903,4.45519055140205,4.38940474321811,4.6009897084014,4.17388344451793,3.50938850173903]}]],[[{"lng":[12.9955102759003,12.6207539842475,12.3186027543647,11.9149591381589,11.0937703207576,11.8551178281039,11.478035597875,11.8209597267946,12.4956972096883,12.5752786518182,13.1096111412955,13.9923953914603,14.2991963991528,14.4254409919087,14.3164044340315,13.8433095852702,14.2762521466382,14.0266565633373,13.2826230567293,13.0031063794338,13.0758148730658,14.3377984603732,15.1463213136243,15.9408890561445,16.0128217838909,16.5370198203329,17.1329930936567,17.809834599116,18.452979573065,18.3937083700255,18.0942011707037,17.8987664412458,17.7741261579166,17.8264728864322,17.663489807955,17.6385824309057,17.5236569899604,16.8652620742655,16.4070553179944,15.972773200448,16.0062593231188,15.7535132481859,15.1709712749596,14.5825885332925,14.2090220936243,14.1449436501065,13.6002253244902,13.2582322682258,12.9955102759003],"lat":[-4.78110294769538,-4.43802316522507,-4.60622997195689,-5.03798658244759,-3.97882650168124,-3.42687050476434,-2.765618913579,-2.51416138817511,-2.39168821863206,-1.9485111517738,-2.42874018537821,-2.47080473644133,-1.99827545730708,-1.3334065359013,-0.552627401288457,0.0387576327403067,1.19692972176441,1.39567727361929,1.31418357628837,1.83089620299118,2.26709693970841,2.22787444504216,1.96401454324959,1.72767234503369,2.26763929111474,3.19825409308298,3.72819570725287,3.560195541376,3.50438491651243,2.90044260277509,2.36572088824896,1.74183150253962,0.855658446868776,0.288923165608205,-0.0580839828331749,-0.424831526391425,-0.743830064112604,-1.22581607119338,-1.7409266821585,-2.71239181687053,-3.53513216690159,-3.8551643116507,-4.34350664223147,-4.97023845820613,-4.79309172218272,-4.51000825597937,-4.50013813042263,-4.88295716121325,-4.78110294769538]}]],[[{"lng":[11.0937703207576,10.0661338956646,9.40524445728814,8.79799499667246,8.83008604623655,9.04841887215651,9.29134965321711,9.49288762264742,9.83028281731439,11.2850760764528,11.2764461563099,11.7516617663446,12.3593751569332,12.9513268177443,13.0758148730658,13.0031063794338,13.2826230567293,14.0266565633373,14.2762521466382,13.8433095852702,14.3164044340315,14.4254409919087,14.2991963991528,13.9923953914603,13.1096111412955,12.5752786518182,12.4956972096883,11.8209597267946,11.478035597875,11.8551178281039,11.0937703207576],"lat":[-3.97882650168124,-2.96948247673602,-2.1443132259741,-1.11130135737141,-0.7790735762639,-0.459351491400295,0.268666080762297,1.01011952354669,1.0678937720066,1.0576618237198,2.26105087190009,2.32675743840617,2.19281210703561,2.32161557967596,2.26709693970841,1.83089620299118,1.31418357628837,1.39567727361929,1.19692972176441,0.0387576327403067,-0.552627401288457,-1.3334065359013,-1.99827545730708,-2.47080473644133,-2.42874018537821,-1.9485111517738,-2.39168821863206,-2.51416138817511,-2.765618913579,-3.42687050476434,-3.97882650168124]}]],[[{"lng":[1.06012169711635,-0.507637905301297,-1.0636246403038,-1.96470659016799,-2.8561250472024,-2.81070146321784,-3.24437008301126,-2.98358496745033,-2.56218950032625,-2.82749630371271,-2.96389624674711,-2.94040930827046,-1.20335771321599,-0.761575893562303,-0.438701544616443,0.023802524356833,-0.049784715220552,0.367579990116591,0.365900506058771,0.461191847172197,0.712029249430709,0.490957472148035,0.570384148548515,0.83693118618706,1.06012169711635],"lat":[5.92883738850617,5.34347260174175,5.00054779705363,4.71046214438337,4.99447581625951,5.38905121502411,6.2504715031135,7.37970490155551,8.21962779381148,9.64246084231978,10.3953347843801,10.9626903345126,11.0098192407625,10.9369296330142,11.0983409692767,11.0186817488951,10.7069178328791,10.1912128768165,9.46500397381943,8.6772226017448,8.31246450440687,7.41174428956608,6.91435862875587,6.2799787459356,5.92883738850617]}]],[[{"lng":[-8.43929846601531,-8.72212357906818,-8.92606461818451,-9.20878637780929,-9.40334814425244,-9.33727982618874,-9.75534216069942,-10.0165665232919,-10.2300935389331,-10.5054772424638,-10.4943151337979,-10.6547704537589,-10.6223951699834,-10.8391519620565,-11.1174812212036,-11.9172773373814,-12.1503380346831,-12.4259284316252,-12.5967190267809,-12.7119574594671,-13.2465500925355,-13.6851537574461,-14.0740446852346,-14.3300755156162,-14.5796984629549,-14.6932315651086,-14.8395533459047,-15.1303106986937,-14.6856868335548,-14.3821912214719,-14.1214061632835,-13.9007995121977,-13.7431605818449,-13.8282716592104,-13.7187434783924,-13.700475867696,-13.2178180437602,-12.4990505972951,-12.278598948678,-12.2035647731457,-11.6583009170936,-11.5139428076557,-11.4561685564581,-11.2975735895527,-11.0365559356646,-10.8708296199815,-10.5932238290903,-10.165213783068,-9.89099279747691,-9.56791174477241,-9.32761633575836,-9.12747351418383,-8.90526485588827,-8.78609900323371,-8.37630489591144,-8.58130530234628,-8.62032100855091,-8.40731075512833,-8.28235714205238,-8.33537716143274,-8.02994360883005,-8.22933712249907,-8.3096164598558,-8.0791137339716,-7.83210038789785,-8.20349890614486,-8.2990486292277,-8.22179236309123,-8.28070349571078,-8.43929846601531],"lat":[7.68604279198493,7.71167430232053,7.30903738005886,7.31392080278362,7.52690521835139,7.92853445014086,8.54105520172826,8.4285039319269,8.40620555111608,8.348896387272,8.7155406743404,8.9771784506716,9.26791005876127,9.6882461584357,10.0458729072198,10.046983946969,9.85857167347376,9.83583404125256,9.62018828801821,9.34271168401458,8.90304859273976,9.4947437351546,9.88616686341383,10.0157196729942,10.2144672244951,10.656300716181,10.8765715036278,11.0404116213756,11.5278237452045,11.5092719148918,11.6771169733156,11.678718947631,11.8112689994845,12.1426441195146,12.2471855441123,12.5861829399926,12.5758734998964,12.332089939235,12.3544399981282,12.4656476809762,12.3865827431673,12.4429875697422,12.0768342091029,12.0779710913078,12.2112446111471,12.1778874746422,11.9239753253631,11.8440835619193,12.0604786225415,12.194243067904,12.334286199631,12.3080604103949,12.0883580586485,11.8125609395744,11.3936459413659,11.1362456320553,10.8108908143374,10.909256903276,10.7925973574144,10.4948119163224,10.2065349388565,10.1290202903768,9.78953196842041,9.37622386300662,8.57570425042122,8.45545319241766,8.31644358953437,8.1233287620791,7.68717967353084,7.68604279198493]}]],[[{"lng":[9.49288762264742,9.30561234403265,9.64915706559924,11.2764461563099,11.2850760764528,9.83028281731439,9.49288762264742],"lat":[1.01011952354669,1.1609113526702,2.28386605021039,2.26105087190009,1.0576618237198,1.0678937720066,1.01011952354669]}]],[[{"lng":[-7.71215938843775,-7.97410722326038,-9.00479366175412,-9.91342036343256,-10.7653838503301,-11.438779420345,-11.1998017682919,-11.1467042363818,-10.6955948327752,-10.2300935389331,-10.0165665232919,-9.75534216069942,-9.33727982618874,-9.40334814425244,-9.20878637780929,-8.92606461818451,-8.72212357906818,-8.43929846601531,-8.48544551987079,-8.38545162358773,-8.60288021171268,-8.31134761977995,-7.99369259119141,-7.57015255275824,-7.53971513415807,-7.63536821020121,-7.71215938843775],"lat":[4.36456594479208,4.35575511306665,4.8324185243354,5.59356069504447,6.14071075902982,6.78591685259475,7.10584564547962,7.39670644467663,7.93946401394317,8.40620555111608,8.4285039319269,8.54105520172826,7.92853445014086,7.52690521835139,7.31392080278362,7.30903738005886,7.71167430232053,7.68604279198493,7.39520783104124,6.91180064520027,6.46756419496373,6.19303314848148,6.12618968336007,5.70735219967822,5.31334524167375,5.18815908444142,4.36456594479208]}]],[[{"lng":[-12.1707502533105,-11.8342074988342,-11.6660782327491,-11.3490950026179,-10.6507913801562,-10.0868464783484,-9.70025508977493,-9.55023840743161,-5.5377443098944,-5.31527726888426,-5.48852250813987,-5.97112870932831,-6.45378658699909,-4.92333736817634,-1.55005489745744,1.82322757343492,2.06099083841434,2.68358849477697,3.14666100461016,3.15813317230925,4.26741946741877,4.27020999187913,3.72342166274594,3.63825890204849,2.74999270892018,1.38552819151478,1.01578331853864,0.374892205348796,-0.266257290053413,-0.515854458014002,-1.0663634912097,-2.00103512206893,-2.19182451009044,-2.96769446452058,-3.10370683431276,-3.52280270019985,-4.00639075358704,-4.28040503581422,-4.42716610352258,-5.22094194173057,-5.19784257649633,-5.47056494790555,-5.40434159992548,-5.81692623531554,-6.05045203281565,-6.2052229475107,-6.4939650128835,-6.66646094382822,-6.85050655736667,-7.62275916105499,-7.89958980855816,-8.02994360883005,-8.33537716143274,-8.28235714205238,-8.40731075512833,-8.62032100855091,-8.58130530234628,-8.37630489591144,-8.78609900323371,-8.90526485588827,-9.12747351418383,-9.32761633575836,-9.56791174477241,-9.89099279747691,-10.165213783068,-10.5932238290903,-10.8708296199815,-11.0365559356646,-11.2975735895527,-11.4561685564581,-11.5139428076557,-11.4678991088003,-11.5533977654506,-11.9277159935298,-12.1248874175048,-12.1707502533105],"lat":[14.6168342040062,14.799096983092,15.3882083121413,15.4112560026042,15.1327458733725,15.3304857428006,15.2641073661187,15.4864968926594,15.5016897648667,16.2018537459903,16.3251020370056,20.6408334416381,24.9565906844689,24.97457408294,22.7926659204972,20.6108094342915,20.142233384423,19.8562301696304,19.6935785986512,19.0573642025046,19.1552652018061,16.8522274822479,16.1842837576491,15.5681198173562,15.40952484741,15.3235611026801,14.9681822778439,14.9289081893316,14.9243089868683,15.1161577417536,14.9738150090073,14.5590082870009,14.2464175480674,13.7981503361515,13.5412667912286,13.3376616479986,13.4724854598481,13.2284435083497,12.5426455754042,11.7138589543063,11.3751457788493,10.9512698429744,10.3707368026078,10.2225546330087,10.0963607853498,10.5240607772111,10.4113028019445,10.4308106551297,10.1389938419711,10.1472362328641,10.2973821068481,10.2065349388565,10.4948119163224,10.7925973574144,10.909256903276,10.8108908143374,11.1362456320553,11.3936459413659,11.8125609395744,12.0883580586485,12.3080604103949,12.334286199631,12.194243067904,12.0604786225415,11.8440835619193,11.9239753253631,12.1778874746422,12.2112446111471,12.0779710913078,12.0768342091029,12.4429875697422,12.7545189419638,13.1412136842923,13.4220750915223,13.9947274743868,14.6168342040062]}]],[[{"lng":[-12.1707502533105,-12.8306582703691,-13.4357375836723,-14.099521290584,-14.5773473519127,-15.135736912749,-15.6236656178619,-16.1206893173872,-16.463097135365,-16.549706802081,-16.2705509154767,-16.1463467112392,-16.256882562947,-16.3776503214313,-16.2778373572848,-16.5363227076127,-17.0634218670166,-16.8451924911983,-12.9291019125747,-13.1187544167592,-12.8742215488339,-11.9372244952044,-11.9694189136678,-8.68729366847561,-8.68439978840698,-4.92333736817634,-6.45378658699909,-5.97112870932831,-5.48852250813987,-5.31527726888426,-5.5377443098944,-9.55023840743161,-9.70025508977493,-10.0868464783484,-10.6507913801562,-11.3490950026179,-11.6660782327491,-11.8342074988342,-12.1707502533105],"lat":[14.6168342040062,15.3036914970441,16.0393830164271,16.3043022330937,16.5982636055386,16.5872823450555,16.3693369713854,16.4556624270162,16.1350359819978,16.6738919769059,17.1669626738768,18.108481442562,19.0967156955007,19.593817133796,20.092520550895,20.5678662070494,20.9997519770821,21.3333233576485,21.327070604487,22.771220178495,23.2848322418839,23.3745942136303,25.9333527570494,25.8810562191993,27.3957441260081,24.97457408294,24.9565906844689,20.6408334416381,16.3251020370056,16.2018537459903,15.5016897648667,15.4864968926594,15.2641073661187,15.3304857428006,15.1327458733725,15.4112560026042,15.3882083121413,14.799096983092,14.6168342040062]}]],[[{"lng":[2.15447350311457,2.17710778054444,1.02410322405381,0.993045688274141,0.429927605719305,0.295646396430766,0.374892205348881,1.01578331853861,1.3855281915149,2.74999270892024,3.6382589020486,3.72342166274606,4.27020999187922,4.26741946741883,5.67756594669083,8.57289293929815,11.9995027180549,13.5814165419884,14.1438599138233,14.8512831270849,15.0968698013243,15.4710550452975,15.4871265311512,15.9032201983669,15.6857173698804,15.3004231956157,15.2477139690934,13.9721931114589,13.540386527639,13.9566900023095,13.9544677929281,14.5957687043923,14.4957753229596,14.2135202868384,14.1813259614574,13.9953434392294,13.3186953092054,13.0839817359324,12.3020675622815,11.5278009371648,10.9895915361104,10.7010305960816,10.1148135757969,9.52492738259654,9.01493285948387,7.80467108489661,7.3307465748409,6.82044184743005,6.44542600279257,5.44305828010658,4.3683435317371,4.10794599101646,3.96728274256282,3.68063357390459,3.61118044857088,2.84864301689058,2.49016360683257,2.15447350311457],"lat":[11.9401500511226,12.6250178082735,12.8518256697668,13.335749619965,13.9887330184286,14.4442349308685,14.9289081893316,14.9681822778439,15.3235611026802,15.4095248474101,15.5681198173562,16.1842837576491,16.852227482248,19.1552652018062,19.6012069686341,21.5656606633444,23.471668329018,23.0405062061104,22.4912892022676,22.8629506538284,21.308519291223,21.0484578444165,20.7304151734654,20.3876198071674,19.9571806596958,17.9279498612485,16.6273055007695,15.684365515723,14.3671332380937,13.9966906669259,13.353448252555,13.330426309558,12.8593956214442,12.8020348240144,12.4836563205343,12.4615646764757,13.5563558610557,13.5961467471126,13.0371887135733,13.3289797755993,13.3873225166911,13.2469176729868,13.2772517785182,12.851102111825,12.8266591810178,13.3435268907774,13.09803800793,13.1150912375574,13.4927684467459,13.865923971156,13.7474815919668,13.5312157233472,12.9561087086383,12.5529033460844,11.6601671401506,12.2356358907068,12.2330520692483,11.9401500511226]}]],[[{"lng":[8.5002872207628,7.46210794562182,7.08259628560173,6.69807199774639,5.89817256684154,5.3628047559202,5.0335742183888,4.32560711272832,3.57418011985673,2.69170169083768,2.74906253082819,2.72379275568772,2.91230838019662,3.2203515918667,3.70543825924766,3.60007001471975,3.79711225002037,3.57221641859328,3.61118044857085,3.68063357390448,3.96728274256273,4.10794599101641,4.36834353173716,5.44305828010661,6.44542600279249,6.82044184742999,7.33074657484087,7.80467108489653,9.0149328594839,9.5249273825964,10.1148135757969,10.7010305960814,10.9895915361104,11.5278009371647,12.3020675622815,13.0839817359325,13.3186953092054,13.9953434392294,14.1813259614572,14.577164958392,14.4681800032043,14.4153669122666,13.5729417741537,13.308669385071,13.1675931165725,12.9554620258611,12.7536660392653,12.2188679652382,12.0639422929525,11.8393052489045,11.7457710367693,11.0587856003585,10.4973735065711,10.1182755295005,9.52270502355923,9.23316212566663,8.75753242257834,8.5002872207628],"lat":[4.77198291193438,4.41210825071734,4.46468902323613,4.24059417715764,4.262453311042,4.88797068669081,5.61180247419153,6.27065114864126,6.2583004820025,6.25881724670379,7.87073436090112,8.50684540418851,9.13760793664795,9.4441525328256,10.0632103530351,10.3321861832014,10.7347455905203,11.3279393570036,11.6601671401506,12.5529033460845,12.9561087086383,13.5312157233471,13.7474815919667,13.8659239711561,13.4927684467459,13.1150912375573,13.09803800793,13.3435268907775,12.8266591810178,12.8511021118249,13.2772517785181,13.2469176729869,13.387322516691,13.3289797755993,13.0371887135732,13.5961467471127,13.5563558610556,12.4615646764757,12.4836563205343,12.0853601387501,11.9047510224594,11.5723682126307,10.7985654687859,10.1603615809137,9.6406258935254,9.41777131703229,8.71776240831401,8.30582380728665,7.79980820997628,7.39704212822258,6.98138276235677,6.64442664658596,7.05535766564009,7.03876955075356,6.45348230765528,6.44449061766034,5.47966580583134,4.77198291193438]}]],[[{"lng":[-16.713727482863,-17.1261050802292,-17.6250404565951,-17.1851712225853,-16.7007051685261,-16.463097135365,-16.1206893173872,-15.6236656178619,-15.135736912749,-14.5773473519127,-14.099521290584,-13.4357375836723,-12.8306582703691,-12.1707502533105,-12.1248874175048,-11.9277159935298,-11.5533977654506,-11.4678991088003,-11.5139428076557,-11.6583009170936,-12.2035647731457,-12.278598948678,-12.4990505972951,-13.2178180437602,-13.700475867696,-15.5484762848322,-15.8165734808439,-16.147715868871,-16.6774505669758,-16.8415231515307,-15.9312951315814,-15.6909998500939,-15.511811900812,-15.141162836705,-14.7121968882103,-14.2777015391467,-13.8449631689125,-14.046992157228,-14.3767135726278,-14.6870304813564,-15.0817349712747,-15.3987697744758,-15.6245956811594,-16.713727482863],"lat":[13.5949584436447,14.3735155414136,14.7295402794255,14.9194770461474,15.621527256784,16.1350359819978,16.4556624270162,16.3693369713854,16.5872823450555,16.5982636055386,16.3043022330937,16.0393830164271,15.3036914970441,14.6168342040062,13.9947274743868,13.4220750915223,13.1412136842923,12.7545189419638,12.4429875697422,12.3865827431673,12.4656476809762,12.3544399981282,12.332089939235,12.5758734998964,12.5861829399926,12.628169982108,12.5155670227036,12.5477614208751,12.3848514320174,13.1513937769991,13.1302840159123,13.270352998385,13.2785695598924,13.5095115517248,13.2982066358188,13.2805849852225,13.5050415789544,13.7940678600699,13.6256801971171,13.63035690492,13.8764917377403,13.860368677648,13.6235872543951,13.5949584436447]}]],[[{"lng":[-11.438779420345,-11.7081944888962,-12.4280988251904,-12.9490488952195,-13.1240252785513,-13.2465500925355,-12.7119574594671,-12.5967190267809,-12.4259284316252,-12.1503380346831,-11.9172773373814,-11.1174812212036,-10.8391519620565,-10.6223951699834,-10.6547704537589,-10.4943151337979,-10.5054772424638,-10.2300935389331,-10.6955948327752,-11.1467042363818,-11.1998017682919,-11.438779420345],"lat":[6.78591685259475,6.86009837018137,7.26294199416896,7.79864572477538,8.16394642235498,8.90304859273976,9.34271168401458,9.62018828801821,9.83583404125256,9.85857167347376,10.046983946969,10.0458729072198,9.6882461584357,9.26791005876127,8.9771784506716,8.7155406743404,8.348896387272,8.40620555111608,7.93946401394317,7.39670644467663,7.10584564547962,6.78591685259475]}]],[[{"lng":[14.4957753229596,14.5957687043923,13.9544677929281,13.9566900023095,13.540386527639,13.9721613358302,15.2477139690934,15.3004231956157,15.6857173698804,15.9032201983669,15.4871265311512,15.4710383510931,15.0968698013243,14.8512831270849,15.8608195829745,19.8490733767723,23.8368096274962,23.8861699626698,23.0240668471815,22.5675199848749,22.3031273717445,22.5116079553586,22.1829287853725,22.2962058039036,22.0372532036563,21.9364875287992,22.2876413604964,22.497223355247,22.5082944790154,22.8757686620333,22.8637172364705,22.2307745634121,21.7235289055144,21.0006459751459,20.0595308103562,19.0939030014518,18.8119160976054,18.9109239067973,18.3894756842399,17.9648630345624,16.7059495574912,16.4561499245878,16.2905294616858,16.1062020608689,15.2794402394353,15.4360700825303,15.120847144519,14.9799785647402,14.5444529149704,13.9542083834663,14.1714550859333,14.6271866661673,14.9093379373059,15.4678518561188,14.9235491968197,14.9601360723785,14.8933450070355,14.4957753229596],"lat":[12.8593956214442,13.330426309558,13.353448252555,13.9966906669259,14.3671332380937,15.6843695627043,16.6273055007695,17.9279498612485,19.9571806596958,20.3876198071674,20.7304151734654,21.048450704836,21.308519291223,22.8629506538284,23.4097218257866,21.4951084460942,19.580581358584,15.6109102128309,15.6807656005104,14.9443217434872,14.3268445524047,14.0932065910635,13.7865006872277,13.3723404711928,12.9554759969429,12.5881938326822,12.6460676118962,12.260258584089,11.6793765660387,11.3846297242255,11.142413736296,10.9719004001584,10.5670626641293,9.47598746303738,9.01270585538664,9.07484589396943,8.98291336832351,8.63089347334295,8.28130224844666,7.89091261838625,7.50832637863817,7.73477255483912,7.75430628617189,7.49708690323581,7.42192374199544,7.69281154816098,8.38214936533318,8.79610344757758,8.96586062299588,9.54949436241728,10.0213776541446,9.9209185738759,9.99212863499376,9.982335826029,10.8913243988107,11.5555732684308,12.2190492630752,12.8593956214442]}]],[[{"lng":[1.86524051133857,1.06012169711635,0.83693118618706,0.570384148548515,0.490957472148035,0.712029249430709,0.461191847172197,0.365900506058771,0.367579990116591,-0.049784715220552,0.023802524356833,0.899563022211253,0.772335645939571,1.07779503708127,1.42506066184709,1.46304283952157,1.66447757238747,1.61895063543497,1.86524051133857],"lat":[6.14215770095267,5.92883738850617,6.2799787459356,6.91435862875587,7.41174428956608,8.31246450440687,8.6772226017448,9.46500397381943,10.1912128768165,10.7069178328791,11.0186817488951,10.9973393823353,10.4708082137198,10.1756065942385,9.82539541257242,9.33462433509547,9.12859039952839,6.83203807206634,6.14215770095267]}]]],null,null,{"lineCap":null,"lineJoin":null,"clickable":true,"pointerEvents":null,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2,"dashArray":null,"smoothFactor":1,"noClip":false},null,null,null,null,null]},{"method":"addPolygons","args":[[[[{"lng":[17.5184393236492,17.4979289781136,17.4363869138219,17.3337810702453,17.190061422324,17.0051650958592,16.7790235290789,16.5115716727275,16.2027592079644,15.8525637403359,15.4610058976059,15.0281662181087,14.5542036637228,14.0393755273736,13.4840584297546,12.8887700153278,12.2541908664777,11.5811860612008,10.8708257096953,10.1244037259004,9.34345402991775,8.52976334557422,7.685379763447,6.81261629175393,5.91404872174511,4.99250729327047,4.05106185812198,3.09300049624185,2.12180183003802,1.14110158686364,0.154654257473313,-0.833709034436854,-1.82012512218216,-2.80074437371882,-3.7717757276377,-4.72952969092082,-5.67045792171947,-6.59118821642125,-7.48855397493994,-8.3596175097574,-9.20168686942806,-10.0123261436854,-10.7893594858311,-11.5308693143453,-12.2351893307271,-12.900893111027,-13.5267790957899,-14.1118528224015,-14.6553072229145,-15.1565017584281,-15.6149410873973,-16.0302538786367,-16.4021722879245,-16.7305125261919,-17.015156861954,-17.2560373240397,-17.4531213046347,-17.6063992078591,-17.7158742453599,-17.781554446849,-17.8034469287899,-17.781554446849,-17.71587424536,-17.6063992078591,-17.4531213046348,-17.2560373240398,-17.0151568619541,-16.7305125261919,-16.4021722879246,-16.0302538786368,-15.6149410873974,-15.1565017584282,-14.6553072229146,-14.1118528224016,-13.52677909579,-12.9008931110272,-12.2351893307273,-11.5308693143455,-10.7893594858313,-10.0123261436856,-9.20168686942825,-8.35961750975759,-7.48855397494013,-6.59118821642145,-5.67045792171966,-4.729529690921,-3.77177572763788,-2.80074437371899,-1.82012512218233,-0.833709034437013,0.154654257473162,1.1411015868635,2.12180183003788,3.09300049624172,4.05106185812187,4.99250729327037,5.91404872174501,6.81261629175385,7.68537976344692,8.52976334557416,9.34345402991769,10.1244037259004,10.8708257096952,11.5811860612008,12.2541908664777,12.8887700153278,13.4840584297545,14.0393755273736,14.5542036637228,15.0281662181087,15.4610058976059,15.8525637403359,16.2027592079644,16.5115716727275,16.7790235290789,17.0051650958592,17.190061422324,17.3337810702453,17.4363869138219,17.4979289781136,17.5184393236492],"lat":[0,-0.886631842563933,-1.77160387500385,-2.65324648818898,-3.5298706813248,-4.39975888423399,-5.26115640738302,-6.11226373814466,-6.95122990815427,-7.77614716262921,-8.58504716687809,-9.3758989863953,-10.1466090731724,-10.8950234802708,-11.6189325073345,-12.3160779496842,-12.984163081238,-13.6208654454975,-14.223852458583,-14.7907997440759,-15.3194120226085,-15.8074462724507,-16.2527367649361,-16.6532214660384,-17.0069691896125,-17.3122067965136,-17.5673456650658,-17.7710066198454,-17.922042503838,-18.0195576179921,-18.0629233333941,-18.0517893027529,-17.9860898541389,-17.8660453322815,-17.6921583500221,-17.4652051120919,-17.1862221623828,-16.8564890725099,-16.477507724094,-16.0509789332211,-15.5787772197625,-15.0629245369068,-14.5055637506564,-13.9089326008517,-13.2753387917492,-12.6071367592452,-11.9067065513662,-11.1764351457992,-10.4187004190152,-9.63585788056487,-8.8302301965647,-8.0040994500441,-7.15970202329345,-6.2992259382822,-5.424810454531,-4.53854769797086,-3.64248607748973,-2.73863523614439,-1.82897227954426,-0.915449022981904,-1.18648119554876e-13,0.915449022981668,1.82897227954402,2.73863523614416,3.6424860774895,4.53854769797063,5.42481045453077,6.29922593828198,7.15970202329322,8.00409945004388,8.83023019656449,9.63585788056466,10.418700419015,11.176435145799,11.906706551366,12.607136759245,13.2753387917491,13.9089326008516,14.5055637506562,15.0629245369066,15.5787772197624,16.050978933221,16.4775077240939,16.8564890725098,17.1862221623827,17.4652051120918,17.6921583500221,17.8660453322814,17.9860898541389,18.0517893027529,18.0629233333941,18.0195576179921,17.922042503838,17.7710066198454,17.5673456650658,17.3122067965136,17.0069691896125,16.6532214660384,16.2527367649361,15.8074462724507,15.3194120226086,14.790799744076,14.223852458583,13.6208654454975,12.984163081238,12.3160779496842,11.6189325073345,10.8950234802708,10.1466090731724,9.3758989863953,8.58504716687809,7.77614716262921,6.95122990815426,6.11226373814464,5.261156407383,4.39975888423396,3.52987068132477,2.65324648818895,1.77160387500381,0.886631842563883,0]}]]],null,null,{"lineCap":null,"lineJoin":null,"clickable":true,"pointerEvents":null,"className":"","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2,"dashArray":null,"smoothFactor":1,"noClip":false},null,null,null,null,null]}],"limits":{"lat":[-18.0629233333941,27.3957441260081],"lng":[-17.8034469287899,31.1684816715193]}},"evals":[],"jsHooks":[]}</script>
<p class="caption">
Figure 4.3: Subset of the <code>africa</code> data selected based on their intersection with a circle 2000 km in radius with a center point at 0 degrees longitude and 0 degrees latitude.
</p>
</div>
<p>Note that countries that just touch the giant circle are selected such as Chad (northeast of the circle). This is because the default subsetting operator is <code>st_intersects()</code>, which returns any type of spatial relation. Other spatial subsetting operations such as <code>st_within()</code> are more conservative, as shown in section <a href="spatial-data-operations.html#topological-relations">4.2.2</a>.</p>
<p>Before we progress to explore the differences between different spatial subsetting operations, it is worth seeing alternative ways to achieve the same result, to deepen understanding of what is going on ‘under the hood’ (which in turn is vital for developing advanced geocomputation applications). The second way to reproduce the subsetting operation illustrated in Figure <a href="spatial-data-operations.html#fig:africa-buff">4.3</a> simply involves expanding the operation over 2 lines:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sel_buff =<span class="st"> </span><span class="kw">st_intersects</span>(<span class="dt">x =</span> africa, <span class="dt">y =</span> buff, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)
africa_buf2 =<span class="st"> </span>africa[sel_buff, ]</code></pre></div>
<p>The third way is essentially the same as the second, but uses the <code>filter()</code> function introduced in section <a href="attr.html#vector-attribute-subsetting">3.2.1</a>, forming the foundations of a ‘tidy’ spatial data analysis workflow. If you already use <strong>dplyr</strong> for data manipulation, this way should seem familiar:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">africa_buf3 =<span class="st"> </span><span class="kw">filter</span>(africa, sel_buff)</code></pre></div>
<p>How can we be sure that the results are the same for the three subsetting operations? We can test them as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">identical</span>(<span class="dt">x =</span> africa_buf, <span class="dt">y =</span> africa_buf2)
<span class="co">#&gt; [1] TRUE</span>
<span class="kw">identical</span>(<span class="dt">x =</span> africa_buf, <span class="dt">y =</span> africa_buf3)
<span class="co">#&gt; [1] FALSE</span></code></pre></div>
<p>The reason that the third spatially subset object (<code>africa_buf3</code>) is not identical is that <strong>dplyr</strong> changes the row names:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(<span class="kw">row.names</span>(africa_buf))
<span class="co">#&gt; [1] &quot;1&quot; &quot;3&quot; &quot;4&quot; &quot;6&quot; &quot;7&quot; &quot;8&quot;</span>
<span class="kw">head</span>(<span class="kw">row.names</span>(africa_buf3))
<span class="co">#&gt; [1] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; &quot;5&quot; &quot;6&quot;</span></code></pre></div>
<p>If the row names are re-set, the objects become identical:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">attr</span>(africa_buf3, <span class="st">&quot;row.names&quot;</span>) =<span class="st"> </span><span class="kw">attr</span>(<span class="dt">x =</span> africa_buf, <span class="st">&quot;row.names&quot;</span>)
<span class="kw">identical</span>(africa_buf, africa_buf3)
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<div class="rmdnote">
<p>
This discarding of row names is not something that is specific to spatial data, as illustrated in the code chunk below. <strong>dplyr</strong> discards row names by design. For further discussion of this decision, and some controversy, see the (closed) issue <a href="https://github.com/tidyverse/dplyr/issues/366">#366</a> in the package’s issue tracker.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">row.names</span>(africa[africa$subregion ==<span class="st"> &quot;Northern Africa&quot;</span>, ])
<span class="co">#&gt; [1] &quot;12&quot; &quot;13&quot; &quot;24&quot; &quot;26&quot; &quot;36&quot; &quot;37&quot; &quot;46&quot;</span>
<span class="kw">row.names</span>(<span class="kw">filter</span>(africa, subregion ==<span class="st"> &quot;Northern Africa&quot;</span>))
<span class="co">#&gt; [1] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; &quot;5&quot; &quot;6&quot; &quot;7&quot;</span></code></pre></div>
</div>
<div id="topological-relations" class="section level3">
<h3><span class="header-section-number">4.2.2</span> Topological relations</h3>
<!-- http://lin-ear-th-inking.blogspot.com/2007/06/subtleties-of-ogc-covers-spatial.html -->
<!-- https://edzer.github.io/sfr/articles/sf3.html -->
<!-- https://github.com/edzer/sfr/wiki/migrating#relevant-commands-exported-by-rgeos -->
<!-- Relations and inverse relations -->
<!-- http://desktop.arcgis.com/en/arcmap/latest/extensions/data-reviewer/types-of-spatial-relationships-that-can-be-validated.htm -->
<!-- Topological relations: + difference between datatypes -->
<!-- ?geos_binary_pred -->
<!-- Distance relations -->
<!-- Subset (1) points in polygons <-> (2) -->
<p>To understand topological relations, it helps to have some simple test data to work with. Figure <a href="spatial-data-operations.html#fig:relation-objects">4.4</a> illustrates a polygon (<code>a</code>), a line (<code>l</code>) and some points (<code>p</code>). These objects are created in the code below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a_poly =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(-<span class="dv">1</span>, -<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">1</span>, -<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="kw">c</span>(-<span class="dv">1</span>, -<span class="dv">1</span>))))
a =<span class="st"> </span><span class="kw">st_sfc</span>(a_poly)

l_line =<span class="st"> </span><span class="kw">st_linestring</span>(<span class="dt">x =</span> <span class="kw">matrix</span>(<span class="kw">c</span>(-<span class="dv">1</span>, -<span class="dv">1</span>, -<span class="fl">0.5</span>, <span class="dv">1</span>), , <span class="dv">2</span>))
l =<span class="st"> </span><span class="kw">st_sfc</span>(l_line)

p_matrix =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>, -<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="dt">ncol =</span> <span class="dv">2</span>)
p_multi =<span class="st"> </span><span class="kw">st_multipoint</span>(<span class="dt">x =</span> p_matrix)
p =<span class="st"> </span><span class="kw">st_sf</span>(<span class="kw">st_cast</span>(<span class="kw">st_sfc</span>(p_multi), <span class="st">&quot;POINT&quot;</span>))</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:relation-objects"></span>
<img src="figures/relation-objects-1.png" alt="Points (p 1 to 4), line and polygon objects arranged to demonstrate spatial relations." width="576" />
<p class="caption">
Figure 4.4: Points (p 1 to 4), line and polygon objects arranged to demonstrate spatial relations.
</p>
</div>
<p>A simple query is: which of the points in <code>p</code> intersect in some way with polygon <code>a</code>? The question can be answered by inspection (points 1 and 2 are over or touch the triangle). It can also be answered by using the topological relation <em>intersects</em>, implemented in <strong>sf</strong> as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_intersects</span>(p, a)
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; integer(0)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt; integer(0)</span></code></pre></div>
<p>The contents of the result should be as you expected: the function returns a positive (<code>1</code>) result for the first two points, and a negative result (represented by an empty vector, <code>integer(0)</code>) for the last two. What may be unexpected is that the result comes in the form of a list. This is because topological operations in the <strong>sf</strong> return a sparse matrix by default, which is useful in that it reduces the memory requirements of the output from operations on multi-feature objects. To return the result as a logical vector, of the type that can be used for subsetting and other operations, the result must be returned as a <em>dense matrix</em>. This can be done by setting the <code>sparse</code> argument to <code>FALSE</code> as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_intersects</span>(p, a, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)
<span class="co">#&gt;       [,1]</span>
<span class="co">#&gt; [1,]  TRUE</span>
<span class="co">#&gt; [2,]  TRUE</span>
<span class="co">#&gt; [3,] FALSE</span>
<span class="co">#&gt; [4,] FALSE</span></code></pre></div>
<p>The output is an matrix with the four rows representing the four features in the target object <code>p</code>. The rows represent features in the selecting object: the first two features in <code>p</code> intersect with <code>a</code> (There is only one feature in <code>a</code> so the result has only one column). The result can be used to subset the features of <code>p</code> in a two-stage operation that is equivalent of <code>p[a, ]</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sel =<span class="st"> </span><span class="kw">st_intersects</span>(p, a, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)[, <span class="dv">1</span>]
p[sel, ]</code></pre></div>
<p>Note the use of <code>[, 1]</code> to select only the first column — we’ll use this to return only a vector instead of matrix in subsequent code chunks. This operator ensures that the intermediary object <code>sel</code> is a <code>logical</code> vector (rather than a matrix).</p>
<p><code>st_intersects()</code> returns <code>TRUE</code> for the second feature in the object <code>p</code> even though it just touches the polygon <code>a</code>. This is because <em>intersects</em> is a catch-all topological operation that covers any type of spatial relation. There are many other topological operations that you can use, some of which we’ll demonstrate below. The opposite of <code>st_intersects()</code> is <code>st_disjoint()</code>, which returns only objects that do not spatially relate in any way to the selecting object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_disjoint</span>(p, a, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)[, <span class="dv">1</span>]
<span class="co">#&gt; [1] FALSE FALSE  TRUE  TRUE</span></code></pre></div>
<p>Other topological operators are more specific. <code>st_within()</code>, for example, returns <code>TRUE</code> only for objects that are completely within the selecting object. This applies only to the second object, which is inside the triangular polygon, as illustrated below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_within</span>(p, a, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)[, <span class="dv">1</span>]
<span class="co">#&gt; [1]  TRUE FALSE FALSE FALSE</span></code></pre></div>
<p>Note that although point 1 is <em>within</em> the triangle, it does not <em>touch</em> any part of its border. For this reason <code>st_touches()</code> only returns <code>TRUE</code> for the second point:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_touches</span>(p, a, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)[, <span class="dv">1</span>]
<span class="co">#&gt; [1] FALSE  TRUE FALSE FALSE</span></code></pre></div>
<p>What about features that do not touch, but <em>almost touch</em> the selection object? These can be selected using <code>st_is_within_distance()</code>, which has an additional <code>dist</code> argument. It can be used to set how close target object need to be before they are selected. Note that although point 4 is one unit of distance from the nearest node of <code>a</code> (at point 2 in Figure <a href="spatial-data-operations.html#fig:relation-objects">4.4</a>), it is still selected when the distance is set to 0.9. This is illustrated in the code chunk below, the second line of which converts the lengthy list output into a <code>logical</code> object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sel =<span class="st"> </span><span class="kw">st_is_within_distance</span>(p, a, <span class="dt">dist =</span> <span class="fl">0.9</span>) <span class="co"># can only return a sparse matrix</span>
<span class="kw">lengths</span>(sel) &gt;<span class="st"> </span><span class="dv">0</span>
<span class="co">#&gt; [1]  TRUE  TRUE FALSE  TRUE</span></code></pre></div>
<!-- Equals: -->
<!-- https://postgis.net/docs/ST_Equals.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_equals(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Contains: -->
<!-- https://postgis.net/docs/ST_Contains.html -->
<!-- https://postgis.net/docs/ST_ContainsProperly.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_contains(a, b, sparse = FALSE) -->
<!-- st_contains_properly(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Covers: -->
<!-- https://postgis.net/docs/ST_Covers.html -->
<!-- https://postgis.net/docs/ST_CoveredBy.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_covers(a, b, sparse = FALSE) -->
<!-- st_covered_by(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Within: -->
<!-- https://postgis.net/docs/ST_Within.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_within(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Overlaps: -->
<!-- https://postgis.net/docs/ST_Overlaps.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_overlaps(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Intersects: -->
<!-- https://postgis.net/docs/ST_Intersects.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_intersects(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Disjoint: -->
<!-- https://postgis.net/docs/ST_Disjoint.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_disjoint(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Touches: -->
<!-- https://postgis.net/docs/ST_Touches.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_touches(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Crosses: -->
<!-- https://postgis.net/docs/ST_Crosses.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_crosses(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- DE9-IM - https://en.wikipedia.org/wiki/DE-9IM -->
<!-- https://edzer.github.io/sfr/reference/st_relate.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_relate(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- examples (points/polygons) -->
<!-- examples (points/lines) -->
<!-- examples (lines/polygons) -->
<!-- TODO? create a series of polygons distributed evenly over the surface of the Earth and clip them. -->
<!-- ```{r} -->
<!-- set.seed(2018) -->
<!-- blob_points = st_sample(x = world, size = 2) -->
<!-- blobs = st_buffer(x = blob_points, dist = 1) -->
<!-- plot(blobs) -->
</div>
<div id="spatial-joining-and-aggregation" class="section level3">
<h3><span class="header-section-number">4.2.3</span> Spatial joining and aggregation</h3>
<p>Joining two non-spatial datasets relies on a shared ‘key’ variable, as described in section <a href="attr.html#vector-attribute-joining">3.2.3</a>. Spatial data joining applies the same concept, but instead relies on shared areas of geographic space. As with attribute data joining adds a new column to the target object (the argument <code>x</code> in joining functions) from a source object (<code>y</code>).</p>
<p>The process is illustrated in Figure <a href="spatial-data-operations.html#fig:spatial-join">4.5</a>, which shows a target object (the <code>world</code> dataset, left) being joined to a source dataset (the three most populous cities of the world), resulting in a new attribute being added to the <code>world</code> dataset (right). <!-- Idea: use random points over Earth's surface to allocate data to world countries. --> <!-- I'm not sure this is a good starting example to show how st_join works - thoughts? --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">urb =<span class="st"> </span>urban_agglomerations %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year ==<span class="st"> </span><span class="dv">2020</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dt">n =</span> <span class="dv">3</span>, <span class="dt">wt =</span> population_millions)
asia =<span class="st"> </span>world %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(continent ==<span class="st"> &quot;Asia&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">joined =<span class="st"> </span><span class="kw">st_join</span>(<span class="dt">x =</span> asia, <span class="dt">y =</span> urb) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">na.omit</span>()</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:spatial-join"></span>
<img src="figures/spatial-join-1.png" alt="Illustration of a spatial join: the populations of the world's 3 largest agglomerations joined onto their respective countries." width="576" />
<p class="caption">
Figure 4.5: Illustration of a spatial join: the populations of the world’s 3 largest agglomerations joined onto their respective countries.
</p>
</div>
<p>This operation is also know as spatial overlay. By default, <code>st_join()</code> performs a left join (see section <a href="attr.html#vector-attribute-joining">3.2.3</a>), but it can also do inner joins by setting the argument <code>left = FALSE</code>. Like spatial subsetting, the default topological operator used by <code>st_join()</code> is <code>st_intersects()</code>. This can be changed with the <code>join</code> argument (see <code>?st_join</code> for details). In the example above, we have added features of a point layer to a polygon layer but there might be multiple point matches per polygon. Had we chosen to select the four (instead of three) most populous cities in the world, two of them would have belonged to China (Shanghai and Beijing, give it a try yourself). In such a case <code>st_join()</code> simply adds a new row. In our example we would have ended up with two polygons representing China.</p>
</div>
<div id="non-overlapping-joins" class="section level3">
<h3><span class="header-section-number">4.2.4</span> Non-overlapping joins</h3>
<p>Sometimes two geographic datasets do not touch but still have a strong geographic relationship enabling joins. The datasets <code>cycle_hire</code> and <code>cycle_hire_osm</code>, already loaded in the <strong>spData</strong> package, provide a good example. Plotting them shows that they are closely related but they do not touch, as shown in Figure <a href="spatial-data-operations.html#fig:cycle-hire">4.6</a>, a base version of which is created with the following code below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(cycle_hire$geometry, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>)
<span class="kw">plot</span>(cycle_hire_osm$geometry, <span class="dt">add =</span> T, <span class="dt">pch =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</code></pre></div>
<p>We can check if any points are the same <code>st_intersects()</code> as show below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">any</span>(<span class="kw">st_touches</span>(cycle_hire, cycle_hire_osm, <span class="dt">sparse =</span> <span class="ot">FALSE</span>))
<span class="co">#&gt; [1] FALSE</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:cycle-hire"></span>
<img src="figures/cycle-hire-1.png" alt="The spatial distribution of cycle hire points in London based on official data (blue) and OpenStreetMap data (red)." width="576" />
<p class="caption">
Figure 4.6: The spatial distribution of cycle hire points in London based on official data (blue) and OpenStreetMap data (red).
</p>
</div>
<p>Imagine that we need to join the <code>capacity</code> variable in <code>cycle_hire_osm</code> onto the official ‘target’ data contained in <code>cycle_hire</code>. This is when a non-overlapping join is needed. The simplest method is to use the topological operator <code>st_within_distance()</code> shown in section <a href="spatial-data-operations.html#topological-relations">4.2.2</a>. Note that before performing the relation both datasets must be transformed into a projected CRS, saved as new objects denoted by the affix <code>P</code> (for projected) below, using a treshold distance of 20 m:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># factor -&gt; numeric: to be removed with later version of spData</span>
cycle_hire_osm$capacity =<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(cycle_hire_osm$capacity))
x =<span class="st"> </span><span class="kw">st_transform</span>(cycle_hire, <span class="dv">27700</span>)
y =<span class="st"> </span><span class="kw">st_transform</span>(cycle_hire_osm, <span class="dv">27700</span>)
sel =<span class="st"> </span><span class="kw">st_is_within_distance</span>(x, y, <span class="dt">dist =</span> <span class="dv">20</span>)
<span class="kw">summary</span>(<span class="kw">lengths</span>(sel) &gt;<span class="st"> </span><span class="dv">0</span>)
<span class="co">#&gt;    Mode   FALSE    TRUE </span>
<span class="co">#&gt; logical     304     438</span></code></pre></div>
<p>This shows that there are 436 points in the target object <code>cycle_hire</code> within the threshold distance. How to retrieve the <em>values</em> associated with the respective <code>cycle_hire_osm</code> points though? The solution is again with <code>st_join()</code> although the additional dist argument must be specified:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">z =<span class="st"> </span><span class="kw">st_join</span>(x, y, st_is_within_distance, <span class="dt">dist =</span> <span class="dv">20</span>)
<span class="kw">nrow</span>(cycle_hire)
<span class="co">#&gt; [1] 742</span>
<span class="kw">nrow</span>(z)
<span class="co">#&gt; [1] 762</span></code></pre></div>
<p>Note that the number of rows in the joined result is greater than the target. This is because some cycle hire stations in <code>x</code> have multiple matches in <code>y</code>. To aggregate the values for the overlapping points and return the mean, we can use the aggregation methods learned in Chapter 3, resulting in an object with the same number of rows as the target:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">z =<span class="st"> </span>z %&gt;%<span class="st"> </span><span class="kw">group_by</span>(id) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">capacity =</span> <span class="kw">mean</span>(capacity))
<span class="kw">nrow</span>(z) ==<span class="st"> </span><span class="kw">nrow</span>(cycle_hire)
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<p>The capacity of nearby stations can be verified by comparing a plot of the capacity of the source <code>cycle_hire_osm</code> data with the results in this new object (plots not show):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(cycle_hire_osm[<span class="st">&quot;capacity&quot;</span>])
<span class="kw">plot</span>(z[<span class="st">&quot;capacity&quot;</span>])</code></pre></div>
<!-- Nearest neighbour analysis -->
<!-- e.g. two point's datasets (non-overlapping) -->
<!-- e.g. two point's datasets (overlapping) -->
<!-- ? topological problems of joining lines/polygons? -->
<!-- joining different types (e.g. points + polygons = geometry) -> save as GPKG? -->
<!-- `merge()`; `st_interpolate_aw()` -->
<!--### Modifying geometry data; still need to change the corresponding cross-references-->
</div>
<div id="aggregating-or-dissolving" class="section level3">
<h3><span class="header-section-number">4.2.5</span> Aggregating or dissolving</h3>
<p>In the subsequent sections, we will present spatial operations that also act on and modify the underlying geometry, namely aggregating (dissolving) and clipping operations.</p>
<p>Like attribute data aggregation, covered in section <a href="attr.html#vector-attribute-aggregation">3.2.2</a>, spatial data aggregation (also known as dissolving polygons) can be a way of <em>condensing</em> data. Aggregated data show some statistic about a variable (typically mean average or total) in relation to some kind of <em>grouping variable</em>. For attribute data aggregation the grouping variable is another variable, typically one with few unique values relative to the number of rows. The <code>REGION</code> variable in the <code>us_states</code> dataset is a good example: there are only four subregions but 49 states (excluding Hawaii and Alaska). In section <a href="attr.html#vector-attribute-aggregation">3.2.2</a> we have already seen how attribute aggregation process condensed the <code>world</code> dataset down into only eight rows. Spatial data aggregation is the same conceptually but in addition to aggregating the attribute data, it dissolves the underlying polygons. Here, we want to aggregate the state population into regions. This means that we not only end up with four rows but also with four polygons (out of 49 in the beginning). As with spatial subsetting, spatial aggregation operations work by extending existing functions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">regions =<span class="st"> </span><span class="kw">aggregate</span>(<span class="dt">x =</span> us_states[, <span class="st">&quot;total_pop_15&quot;</span>], <span class="dt">by =</span> <span class="kw">list</span>(us_states$REGION),
                    <span class="dt">FUN =</span> sum, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
<span class="kw">plot</span>(us_states[, <span class="st">&quot;total_pop_15&quot;</span>], <span class="dt">main =</span> <span class="st">&quot;US states&quot;</span>)
<span class="kw">plot</span>(regions[, <span class="st">&quot;total_pop_15&quot;</span>], <span class="dt">main =</span> <span class="st">&quot;US regions&quot;</span>)</code></pre></div>
<p><img src="figures/unnamed-chunk-41-1.png" width="576" style="display: block; margin: auto;" /></p>
<p>Spatial aggregation can also be done in the <strong>tidyverse</strong>, using <strong>dplyr</strong> functions as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">group_by</span>(us_states, REGION) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="kw">sum</span>(<span class="dt">pop =</span> total_pop_15, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</code></pre></div>
<!--Not sure how to elegantly include your circle buffer intersection example -->
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">buff_agg =<span class="st"> </span><span class="kw">aggregate</span>(<span class="dt">x =</span> africa[, <span class="st">&quot;pop&quot;</span>], <span class="dt">by =</span> buff, <span class="dt">FUN =</span> sum)</code></pre></div>
<!--
show also tidyverse way, so what you are doing is basically a spatial join and a subsequent aggregation without a grouping variable. Didactically, it might be better to present a grouping variable.

```r
st_join(buff, africa[, "pop"]) %>%
  summarize(pop = sum(pop, na.rm = TRUE))
#> Simple feature collection with 1 feature and 1 field
#> geometry type:  POLYGON
#> dimension:      XY
#> bbox:           xmin: -1166021 ymin: -2e+06 xmax: 2833979 ymax: 2e+06
#> epsg (SRID):    32630
#> proj4string:    +proj=utm +zone=30 +datum=WGS84 +units=m +no_defs
#>        pop                       geometry
#> 1 4.87e+08 POLYGON ((2833978.55690392 ...
# summarize(africa[buff, "pop"], pop = sum(pop, na.rm = TRUE))
```
-->
<p>The result, <code>buff_agg</code>, is a spatial object with the same geometry as <code>by</code> (the circular buffer in this case) but with an additional variable, <code>pop</code> reporting summary statistics for all features in <code>x</code> that intersect with <code>by</code> (the total population of the countries that touch the buffer in this case). Plotting the result (with <code>plot(buff_agg)</code>) shows that the operation does not really make sense: Figure <a href="spatial-data-operations.html#fig:buff-agg">4.7</a> shows a population of over half a billion people mostly located in a giant circle floating off the west coast of Africa!</p>
<div class="figure" style="text-align: center"><span id="fig:buff-agg"></span>
<img src="figures/buff-agg-1.png" alt="Result of spatial aggregation showing the total population of countries that intersect with a large circle whose center lies at 0 degrees longitude and latitude." width="576" />
<p class="caption">
Figure 4.7: Result of spatial aggregation showing the total population of countries that intersect with a large circle whose center lies at 0 degrees longitude and latitude.
</p>
</div>
<p>The results of the spatial aggregation exercise presented in Figure <a href="spatial-data-operations.html#fig:buff-agg">4.7</a> are unrealistic for three reasons:</p>
<ul>
<li>People do not live in the sea (the geometry of the aggregating object is not appropriate for the geometry target object).</li>
<li>This method would ‘double count’ countries whose borders cross aggregating polygons when multiple, spatially contiguous, features are used as the aggregating object.</li>
<li>It is wrong to assume that all the people living in countries that <em>touch</em> the buffer reside <em>within</em> it (the default spatial operator <code>st_intersects()</code> is too ‘greedy’). The most extreme example of this is Algeria, the most northerly country selected: the spatial aggregation operation assumes that all 39 million Algerian citizens reside in the tiny southerly tip that is within the circular buffer.</li>
</ul>
<p>A number of methods can be used to overcome these issues, and generate a more realistic population attributed to the circular buffer illustrated in Figure <a href="spatial-data-operations.html#fig:buff-agg">4.7</a>. The simplest of these is to convert the country polygons into points representing their <em>geographic centroids</em> before aggregation, covered in section <a href="spatial-data-operations.html#modifying-geometry-data">4.2.6</a>. <!-- Todo: reference section where we demonstrate geographic centroid generation --> This would ensure that any spatially contiguous aggregating object covering the target object (the Earth in this case) would result in the same total: there would be no double counting. The estimated total population residing within the study area would be more realistic if geographic centroids were used. (The centroid of Algeria, for example, is far outside the aggregating buffer.)</p>
<p>Except in cases where the number of target features per aggregating feature is very large, or where the aggregating object is <em>spatially congruent</em> with the target (covered in section <a href="spatial-data-operations.html#spatial-congruence-and-areal-interpolation">4.2.5.1</a>), using centroids can also lead to errors due to boundary effects: imagine a buffer that covers a large area but contains no centroids. These issues can be tackled when aggregating areal target data with areal interpolation.</p>
<div id="spatial-congruence-and-areal-interpolation" class="section level4">
<h4><span class="header-section-number">4.2.5.1</span> Spatial congruence and areal interpolation</h4>
<p>Spatial congruence is an important concept related to spatial aggregation. An <em>aggregating object</em> object (which we will refer to as <code>y</code>, representing the buffer object in the previous section) is <em>congruent</em> with the target object (<code>x</code>, representing the countries in the previous section) if the two objects have shared borders. Often this is the case for administrative boundary data, whereby the larger units (e.g., Middle Layer Super Output Areas in the UK or districts in many other European countries) are composed of many smaller units (Output Areas in this case, see <a href="https://www.ons.gov.uk/methodology/geography/ukgeographies/censusgeography">ons.gov.uk</a> for further details or municipalities in many other European countries).</p>
<p><em>Incongruent</em> aggregating objects, by contrast, do not share common borders with the target <span class="citation">(Qiu, Zhang, and Zhou <a href="#ref-qiu_development_2012">2012</a>)</span>. This is problematic for spatial aggregation (and other spatial operations) illustrated in Figure <a href="spatial-data-operations.html#fig:areal-example">4.8</a>. Areal interpolation can help to alleviate this issue. It helps to transfer data from one set of areal units to another. A number of algorithms have been developed for areal interpolation, including area weighted and pycnophylactic interpolation methods task <span class="citation">(Tobler <a href="#ref-tobler_smooth_1979">1979</a>)</span>.</p>
<div class="figure" style="text-align: center"><span id="fig:areal-example"></span>
<img src="figures/areal-example-1.png" alt="Illustration of congruent (left) and incongruent (right) areal units." width="576" />
<p class="caption">
Figure 4.8: Illustration of congruent (left) and incongruent (right) areal units.
</p>
</div>
<p>The simplest useful method for spatial interpolation is <em>area weighted</em> spatial interpolation. This is implemented in <code>st_interpolate_aw()</code>, as demonstrated below: <!-- well, what you are doing here is weighting the inhabitants presumably on the basis of the area. The link between your congruent and incongruent example is somehow missing. One gets the impression, that the spatial interpolation takes care of incongruencies which is not the case. So I would suggest to clarify the weighting procedure.--></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">buff_agg_aw =<span class="st"> </span><span class="kw">st_interpolate_aw</span>(<span class="dt">x =</span> africa[<span class="st">&quot;pop&quot;</span>], <span class="dt">to =</span> buff, <span class="dt">extensive =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Warning in st_interpolate_aw(x = africa[&quot;pop&quot;], to = buff, extensive =</span>
<span class="co">#&gt; TRUE): st_interpolate_aw assumes attributes are constant over areas of x</span></code></pre></div>
<p>Instead of simply aggregating, this procedure additionally applies a weight, in this case simply the area. For instance, if the intersection of our buffer and a country is 100 000 km<sup><sup>2</sup></sup> but the country has 1 mio square kilometers and 1 mio inhabitants, our result will obtain just a tenth of total population, in this case 100 000 inhabitants. <!-- - `aggregate.sf()` - aggregate an sf object, possibly union-ing geometries --> <!-- - disaggregation?? `st_cast()` - https://github.com/edzer/sfr/wiki/migrating --> <!-- - `group_by()` + `summarise()` - potential errors --> <!-- - ? generalization **rmapsharper** - https://github.com/ateucher/rmapshaper --> <!-- `st_union` --></p>
</div>
</div>
<div id="modifying-geometry-data" class="section level3">
<h3><span class="header-section-number">4.2.6</span> Modifying geometry data</h3>
</div>
<div id="clipping" class="section level3">
<h3><span class="header-section-number">4.2.7</span> Clipping</h3>
<p>Spatial clipping is a form of spatial subsetting that involves changes to the <code>geometry</code> columns of at least some of the affected features.</p>
<p>Clipping can only apply to features more complex than points: lines, polygons and their ‘multi’ equivalents. To illustrate the concept we will start with a simple example: two overlapping circles with a centerpoint 1 unit away from each other and radius of 1:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))) <span class="co"># create 2 points</span>
b =<span class="st"> </span><span class="kw">st_buffer</span>(b, <span class="dt">dist =</span> <span class="dv">1</span>) <span class="co"># convert points to circles</span>
l =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>)
<span class="kw">plot</span>(b)
<span class="kw">text</span>(<span class="dt">x =</span> <span class="kw">c</span>(-<span class="fl">0.5</span>, <span class="fl">1.5</span>), <span class="dt">y =</span> <span class="dv">1</span>, <span class="dt">labels =</span> l) <span class="co"># add text</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:points"></span>
<img src="figures/points-1.png" alt="Overlapping circles." width="576" />
<p class="caption">
Figure 4.9: Overlapping circles.
</p>
</div>
<p>Imagine you want to select not one circle or the other, but the space covered by both <code>x</code> <em>and</em> <code>y</code>. This can be done using the function <code>st_intersection()</code>, illustrated using objects named <code>x</code> and <code>y</code> which represent the left and right-hand circles:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x =<span class="st"> </span>b[<span class="dv">1</span>]
y =<span class="st"> </span>b[<span class="dv">2</span>]
x_and_y =<span class="st"> </span><span class="kw">st_intersection</span>(x, y)
<span class="kw">plot</span>(b)
<span class="kw">plot</span>(x_and_y, <span class="dt">col =</span> <span class="st">&quot;lightgrey&quot;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>) <span class="co"># color intersecting area</span></code></pre></div>
<p><img src="figures/unnamed-chunk-46-1.png" width="576" style="display: block; margin: auto;" /></p>
<p>The subsequent code chunk demonstrate how this works for all combinations of the ‘Venn’ diagram representing <code>x</code> and <code>y</code>, inspired by <a href="http://r4ds.had.co.nz/transform.html#logical-operators">Figure 5.1</a> of the book R for Data Science <span class="citation">(Grolemund and Wickham <a href="#ref-grolemund_r_2016">2016</a>)</span>. <!-- Todo: reference r4ds --></p>
<div class="figure" style="text-align: center"><span id="fig:venn-clip"></span>
<img src="figures/venn-clip-1.png" alt="Spatial equivalents of logical operators." width="576" />
<p class="caption">
Figure 4.10: Spatial equivalents of logical operators.
</p>
</div>
<p>To illustrate the relationship between subsetting and clipping spatial data, we will subset points that cover the bounding box of the circles <code>x</code> and <code>y</code> in Figure <a href="spatial-data-operations.html#fig:venn-clip">4.10</a>. Some points will be inside just one circle, some will be inside both and some will be inside neither. To generate the points will use a function not yet covered in this book, <code>st_sample()</code>.</p>
<p>There are two different ways to subset points that fit into combinations of the circles: via clipping and logical operators. But first we must generate some points. We will use the <em>simple random</em> sampling strategy to sample from a box representing the extent of <code>x</code> and <code>y</code>, using the code below to generate the situation plotted in Figure <a href="spatial-data-operations.html#fig:venn-subset">4.11</a>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bb =<span class="st"> </span><span class="kw">st_bbox</span>(<span class="kw">st_union</span>(x, y))
pmat =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(bb[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">2</span>)]), <span class="dt">ncol =</span> <span class="dv">2</span>, <span class="dt">byrow =</span> <span class="ot">TRUE</span>)
box =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(pmat))
<span class="kw">set.seed</span>(<span class="dv">2017</span>)
p =<span class="st"> </span><span class="kw">st_sample</span>(<span class="dt">x =</span> box, <span class="dt">size =</span> <span class="dv">10</span>)
<span class="kw">plot</span>(box)
<span class="kw">plot</span>(x, <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw">plot</span>(y, <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw">plot</span>(p, <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw">text</span>(<span class="dt">x =</span> <span class="kw">c</span>(-<span class="fl">0.5</span>, <span class="fl">1.5</span>), <span class="dt">y =</span> <span class="dv">1</span>, <span class="dt">labels =</span> l)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:venn-subset"></span>
<img src="figures/venn-subset-1.png" alt="Randomly distributed points within the bounding box enclosing circles x and y." width="576" />
<p class="caption">
Figure 4.11: Randomly distributed points within the bounding box enclosing circles x and y.
</p>
</div>
</div>
<div id="distance-relations" class="section level3">
<h3><span class="header-section-number">4.2.8</span> Distance relations</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_distance</span>(a, b)</code></pre></div>
</div>
</div>
<div id="spatial-operations-on-raster-data" class="section level2">
<h2><span class="header-section-number">4.3</span> Spatial operations on raster data</h2>
<p>This section builds on <a href="attr.html#manipulating-raster-objects">3.3</a>, which highlights various basic methods for manipulating raster datasets, to demonstrate more advanced and explicitly spatial raster operations, and uses the same object <code>elev</code> and <code>grain</code>.</p>
<div id="raster-subsetting" class="section level3">
<h3><span class="header-section-number">4.3.1</span> Spatial subsetting</h3>
<p>In the previous chapter (section <a href="attr.html#manipulating-raster-objects">3.3</a>) we have already learned how to subset raster datasets using cell IDs and matrix indexing. Naturally, we can subset rasters also with the help of coordinates and spatial objects. To use coordinates for subsetting, we have to ‘translate’ them into the corresponding cell ID(s) or by using the <code>extract()</code> command. This operation is also known as extracting values/attributes to points.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># point within the top left pixel</span>
elev[<span class="kw">cellFromXY</span>(elev, <span class="dt">xy =</span> <span class="kw">c</span>(-<span class="fl">1.5</span>, <span class="fl">1.5</span>))]
<span class="co"># the same as</span>
<span class="kw">extract</span>(elev, <span class="kw">data.frame</span>(<span class="dt">x =</span> -<span class="fl">1.5</span>, <span class="dt">y =</span> <span class="fl">1.5</span>))</code></pre></div>
<p>The <code>cellFromXY()</code> and the <code>extract()</code> command accept also a <code>SpatialPoints</code> or <code>SpatialPointsDataFrame</code> object (though not an <strong>sf</strong> object). We can also use a raster object to subset another raster object (Figure <a href="spatial-data-operations.html#fig:raster-subset">4.12</a> left panel).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">clip =<span class="st"> </span><span class="kw">raster</span>(<span class="dt">nrow =</span> <span class="dv">3</span>, <span class="dt">ncol =</span> <span class="dv">3</span>, <span class="dt">res =</span> <span class="fl">0.3</span>, <span class="dt">xmn =</span> <span class="fl">0.9</span>, <span class="dt">xmx =</span> <span class="fl">1.8</span>, 
              <span class="dt">ymn =</span> -<span class="fl">0.45</span>, <span class="dt">ymx =</span> <span class="fl">0.45</span>, <span class="dt">vals =</span> <span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">9</span>))
elev[clip]
<span class="co">#&gt; [1] 18 24</span>
<span class="co"># we can also use extract</span>
<span class="co"># extract(elev, extent(clip))</span></code></pre></div>
<p>Basically, this amounts to retrieving the values of the first raster (here: <code>elev</code>) falling within the extent of a second raster (here: <code>clip</code>). To retrieve a spatial output, we can tell R to keep the matrix structure. This will return the two output values as a raster object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">elev[clip, drop =<span class="st"> </span><span class="ot">FALSE</span>]
<span class="co">#&gt; class       : RasterLayer </span>
<span class="co">#&gt; dimensions  : 2, 1, 2  (nrow, ncol, ncell)</span>
<span class="co">#&gt; resolution  : 0.5, 0.5  (x, y)</span>
<span class="co">#&gt; extent      : 1, 1.5, -0.5, 0.5  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : +proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 </span>
<span class="co">#&gt; data source : in memory</span>
<span class="co">#&gt; names       : layer </span>
<span class="co">#&gt; values      : 18, 24  (min, max)</span></code></pre></div>
<p>For the same operation we can also use the <code>intersect()</code> and <code>crop()</code> command.</p>
<div class="figure" style="text-align: center"><span id="fig:raster-subset"></span>
<img src="figures/04_raster_subset.png" alt="Subsetting raster values with the help of another raster (left). Raster mask (middle). Output of masking a raster." width="1125" />
<p class="caption">
Figure 4.12: Subsetting raster values with the help of another raster (left). Raster mask (middle). Output of masking a raster.
</p>
</div>
<p>Frequently, however, we have two rasters with the same extent and resolution where one raster object serves as a mask (Figure <a href="spatial-data-operations.html#fig:raster-subset">4.12</a> middle and right panel). In these cases <code>intersect()</code> and <code>crop()</code> are of little use. Instead we can use the <code>[</code> again or the <code>mask()</code> and <code>overlay()</code> commands:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rmask =<span class="st"> </span><span class="kw">raster</span>(<span class="dt">nrow =</span> <span class="dv">6</span>, <span class="dt">ncol =</span> <span class="dv">6</span>, <span class="dt">res =</span> <span class="fl">0.5</span>, 
               <span class="dt">xmn =</span> -<span class="fl">1.5</span>, <span class="dt">xmx =</span> <span class="fl">1.5</span>, <span class="dt">ymn =</span> -<span class="fl">1.5</span>, <span class="dt">ymx =</span> <span class="fl">1.5</span>,
               <span class="dt">vals =</span> <span class="kw">sample</span>(<span class="kw">c</span>(<span class="ot">FALSE</span>, <span class="ot">TRUE</span>), <span class="dv">36</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>))
elev[rmask, drop =<span class="st"> </span><span class="ot">FALSE</span>]
<span class="co"># using the mask command</span>
<span class="kw">mask</span>(elev, rmask, <span class="dt">maskvalue =</span> <span class="ot">TRUE</span>)
<span class="co"># using overlay</span>
<span class="co"># first we replace FALSE by NA</span>
rmask[rmask ==<span class="st"> </span><span class="ot">FALSE</span>] =<span class="st"> </span><span class="ot">NA</span>
<span class="co"># then we retrieve the maximum values</span>
<span class="kw">overlay</span>(elev, rmask, <span class="dt">fun =</span> <span class="st">&quot;max&quot;</span>)</code></pre></div>
<p>In the code chunk above, we have created a mask object called <code>rmask</code> randomly setting its values to <code>FALSE</code> and <code>TRUE</code>. Next we only want to keep those values of <code>elev</code> which are <code>TRUE</code> in <code>rmask</code>, or expressed differently, we want to mask <code>elev</code> with <code>rmask</code>. These operations are in fact Boolean local operations since we compare cell-wise two rasters. The next subsection explores these and related operations in more detail.</p>
</div>
<div id="map-algebra" class="section level3">
<h3><span class="header-section-number">4.3.2</span> Map algebra</h3>
<p>Map algebra makes raster processing really fast. This is because raster datasets only implicitly store coordinates. To derive the coordinate of a specific cell, we have to calculate it using its matrix position and the raster resolution and origin. For the processing, however, the geographic position of a cell is barely relevant as long as we make sure that the cell position is still the same after the processing (one-to-one locational correspondence). Additionally, if two or more raster datasets share the same extent, projection and the resolution, one could treat them as matrices for the processing. This is exactly what map algebra is doing. First, it checks the headers of the rasters on which to perform any algebraic operation, and only if they correspondent to each other, the processing goes on. And secondly, map algebra retains the so-called one-to-one locational correspondence. This is where it substantially differs from matrix algebra which changes positions when for example multiplying or dividing matrices.</p>
<p>Map algebra (or cartographic modeling) divides raster operations into four subclasses <span class="citation">(Tomlin <a href="#ref-tomlin_geographic_1990">1990</a>)</span>, with each of them either working on one or several grids simultaneously:</p>
<ol style="list-style-type: decimal">
<li><em>Local</em> or per-cell operations.</li>
<li><em>Focal</em> or neighborhood operations. Most often the output cell value is the result of a 3 x 3 input cell block.</li>
<li><em>Zonal</em> operations are similar to focal operations but instead of a predefined neighborhood, classes, which can take on any, i.e., also an irregular size and shape, are the basis for calculations.</li>
<li><em>Global</em> or per-raster operations, that means the output cell derives its value potentially from one or several entire rasters</li>
</ol>
<p>This classification scheme uses basically the number of cells involved in a processing step as distinguishing feature. Raster operations can also be classified by discipline, for example terrain, hydrological analysis or image classifications. The following sections explain how each type of map algebra operations can be used, with reference to worked examples (also see <code>vignette(&quot;Raster&quot;)</code> for a technical description of map algebra).</p>
</div>
<div id="local-operations" class="section level3">
<h3><span class="header-section-number">4.3.3</span> Local operations</h3>
<p><strong>Local</strong> operations comprise all cell-by-cell operations in one or several layers. A good example is the classification of intervals of numeric values into groups such as grouping a digital elevation model into low (class 1), middle (class 2) and high elevations (class 3). Using the <code>reclassify()</code> command, we need first to construct a reclassification matrix, where the first column corresponds to the lower and the second column to the upper end of the class. The third column represents the new value for the specified ranges in column one and two. Here, we assign the raster values in the ranges 0–12, 12–24 and 24–36 are <em>reclassified</em> to take values 1, 2 and 3, respectively.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rcl =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">12</span>, <span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">2</span>, <span class="dv">24</span>, <span class="dv">36</span>, <span class="dv">3</span>), <span class="dt">ncol =</span> <span class="dv">3</span>, <span class="dt">byrow =</span> <span class="ot">TRUE</span>)
recl =<span class="st"> </span><span class="kw">reclassify</span>(elev, <span class="dt">rcl =</span> rcl)</code></pre></div>
<p>Raster algebra is another classical use case of local operations. This includes adding, subtracting and squaring two rasters. Raster algebra also allows logical operations such as finding all raster cells that are greater than a specific value (5 in our example below). The <strong>raster</strong> package supports all these operations and more, as described in <code>vignette(&quot;Raster&quot;)</code> and demonstrated below (results not show):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">elev +<span class="st"> </span>elev
elev^<span class="dv">2</span>
<span class="kw">log</span>(elev)
elev &gt;<span class="st"> </span><span class="dv">5</span></code></pre></div>
<p>Instead of arithmetic operators, one can also use the <code>calc()</code> and <code>overlay()</code> functions. These functions are more efficient, hence, they are preferable in the presence of large raster datasets. Additionally, they allow to directly store an output file.</p>
<p>The calculation of the normalized difference vegetation index (NDVI) is one of the most famous local, i.e. pixel-by-pixel, raster operations. It ranges between - 1 and 1 with positive values indicating the presence of living plants (mostly &gt; 0.2). To calculate the NDVI, one uses the red and near-infrared bands of remotely sensed imagery (e.g., Landsat or Sentinel imagery) exploiting the fact that vegetation absorbs light heavily in the visible light spectrum, and especially in the red channel, while reflecting it in the near-infrared spectrum.</p>
<p><span class="math display">\[
\begin{split}
NDVI&amp;= \frac{\text{NIR} - \text{Red}}{\text{NIR} + \text{Red}}\\
\end{split}
\]</span> where NIR = near infrared channel Red = red channel</p>
<p>Predictive mapping is another interesting application of local raster operations. The response variable correspond to measured or observed points in space, for example, species richness, the presence of landslides, tree disease or crop yield. Consequently, we can easily retrieve space- or airborne predictor variables from various rasters (elevation, pH, precipitation, temperature, landcover, soil class, etc.). Subsequently, we model our response as a function of our predictors using <code>lm</code>, <code>glm</code>, <code>gam</code> or a machine-learning technique. To make a spatial prediction, all we have to do, is to apply the estimated coefficients to the predictor rasters, and summing up the resulting output rasters (<!--Chapter ??; -->see also <span class="citation">Muenchow et al. (<a href="#ref-muenchow_predictive_2013">2013</a>)</span>). <!-- add reference to chapter ecological modeling --></p>
</div>
<div id="focal-operations" class="section level3">
<h3><span class="header-section-number">4.3.4</span> Focal operations</h3>
<p>While local functions operate on one cell, though possibly from multiple layers, <strong>focal</strong> operations take into account a central cell and its neighbors. The neighborhood (also named kernel, filter or moving window) under consideration is typically of size 3-by-3 cells (that is the central cell and its eight surrounding neighbors) but can take on any other (not necessarily rectangular) shape as defined by the user. A focal operation applies an aggregation function to all cells within the specified neighborhood, uses the corresponding output as the new value for the the central cell, and moves on to the next central cell (Figure <a href="spatial-data-operations.html#fig:focal-example">4.13</a>). Other names for this operation are spatial filtering and convolution <span class="citation">(Burrough, McDonnell, and Lloyd <a href="#ref-burrough_principles_2015">2015</a>)</span>.</p>
<p>In R, we can use the <code>focal()</code> function to perform spatial filtering. We define the shape of the moving window with a <code>matrix</code> whose values correspond to weights (see <code>w</code> parameter in the code chunk below). Secondly, the <code>fun</code> parameter lets us specify the function we wish to apply to this neighborhood. Here, we choose the minimum, but any other summary function, including <code>sum()</code>, <code>mean()</code>, or <code>var()</code> can be used.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">r_focal =<span class="st"> </span><span class="kw">focal</span>(elev, <span class="dt">w =</span> <span class="kw">matrix</span>(<span class="dv">1</span>, <span class="dt">nrow =</span> <span class="dv">3</span>, <span class="dt">ncol =</span> <span class="dv">3</span>), <span class="dt">fun =</span> min)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:focal-example"></span>
<img src="figures/04_focal_example.png" alt="Input raster (left) and resulting output raster (right) due to a focal operation - summing up 3-by-3 windows." width="475" />
<p class="caption">
Figure 4.13: Input raster (left) and resulting output raster (right) due to a focal operation - summing up 3-by-3 windows.
</p>
</div>
<p>We can quickly check if the output meets our expectations. In our example, the minimum value has to be always the upper left corner of the moving window (remember we have created the input raster by rowwise incrementing the cell values by one starting at the upper left corner). In this example, the weighting matrix consists only of 1s, meaning each cell has the same weight on the output, but this can be changed.</p>
<p>Focal functions or filters play a dominant role in image processing. Low-pass or smoothing filters use the mean function to remove extremes. In the case of categorical data, we can replace the mean with the mode, which is the most common value. By contrast, high-pass filters accentuate features. The line detection Laplace and Sobel filters might serve as an example here. Check the <code>focal()</code> help page how to use them in R.</p>
<p>Also, terrain processing uses heavily focal functions. Think, for instance, of the calculation of the slope, aspect and flow directions. The <code>terrain()</code> function lets you compute a few of these terrain characteristics but has not implemented all popular methods For example, the Zevenbergen and Thorne method to compute the slope is missing. Equally, many other terrain and GIS functions are <strong>not</strong> implemented in R such as curvatures, contributing areas, different wetness indexes, and many more. Fortunately, desktop GIS commonly provide these algorithms. In Chapter 13 we will learn how to access GIS functionality from within R. <!-- Reference 13-gis chapter --></p>
</div>
<div id="zonal-operations" class="section level3">
<h3><span class="header-section-number">4.3.5</span> Zonal operations</h3>
<p><em>Zonal</em> operations are similar to focal operations. The difference is that zonal filters can take on any shape instead of just a predefined window. Our grain size raster is a good example (Figure <a href="attr.html#fig:cont-cate-rasters">3.2</a>) because the different grain sizes are spread in an irregular fashion throughout the raster.</p>
<p>To find the mean elevation for each grain size class, we can use the <code>zonal()</code> command. This kind of operation is also known as <em>zonal statistics</em> in the GIS world.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">z =<span class="st"> </span><span class="kw">zonal</span>(elev, grain, <span class="dt">fun =</span> <span class="st">&quot;mean&quot;</span>) %&gt;%
<span class="st">  </span>as.data.frame
z
<span class="co">#&gt;   zone mean</span>
<span class="co">#&gt; 1    1 16.8</span>
<span class="co">#&gt; 2    2 19.4</span>
<span class="co">#&gt; 3    3 19.8</span></code></pre></div>
<p>This returns the statistics for each category, here the mean altitude for each grain size class and can be added to the attribute table of the ratified raster (see previous chapter).</p>
</div>
<div id="global-operations-and-distances" class="section level3">
<h3><span class="header-section-number">4.3.6</span> Global operations and distances</h3>
<p><em>Global</em> operations are a special case of zonal operations with the entire raster dataset representing a single zone. The most common global operations are descriptive statistics for the entire raster dataset such as the minimum or maximum (see previous chapter). Aside from that, global operations are also useful for the computation of distance and weight rasters. In the first case, one can calculate the distance from each cell to a specific target cell. For example, one might want to compute the distance to the nearest coast (see also <code>raster::distance()</code>). We might also want to consider topography, that means, we are not only interested in the pure distance but would like also to avoid the crossing of mountain ranges when going to the coast. To do so, we can weight the distance with elevation so that each additional altitudinal meter ‘prolongs’ the euclidean distance. Visibility and viewshed computations also belong to the family of global operations <!--(in the exercises of Chapter ?? you will compute a viewshed raster)-->. <!-- reference 13-gis chapter--></p>
<p>Many map algebra operations have a counterpart in vector processing <span class="citation">(Liu and Mason <a href="#ref-liu_essential_2009">2009</a>)</span>. Computing a distance raster (zonal operation) while only considering a maximum distance (logical focal operation) is the equivalent to a vector buffer operation (section <a href="spatial-data-operations.html#modifying-geometry-data">4.2.6</a>). Reclassifying raster data (either local or zonal function depending on the input) is equivalent to dissolving vector data (section <a href="spatial-data-operations.html#spatial-joining-and-aggregation">4.2.3</a>). Overlaying two rasters (local operation), where one contains <code>NULL</code> or <code>NA</code> values representing a mask, is similar to vector clipping (section <a href="spatial-data-operations.html#modifying-geometry-data">4.2.6</a>). Quite similar to spatial clipping is intersecting two layers (section <a href="spatial-data-operations.html#spatial-subsetting">4.2.1</a>). The difference is that two these two layers (vector or raster) simply share an overlapping area (see Figure <a href="spatial-data-operations.html#fig:venn-clip">4.10</a> for an example). However, be careful with the wording. Sometimes the same words have slightly different meanings for raster and vector data models. Aggregating in the case of vector data refers to dissolving polygons while it means increasing the resolution in the case of raster data. In fact, one could see dissolving or aggregating polygons as decreasing the resolution. However, zonal operations might be the better raster equivalent compared to changing the cell resolution. Zonal operations can dissolve the cells of one raster in accordance with the zones (categories) of another raster using an aggregation function (see above).</p>
</div>
<div id="merging-rasters" class="section level3">
<h3><span class="header-section-number">4.3.7</span> Merging rasters</h3>
<p>Suppose we would like to compute the NDVI (see section <a href="spatial-data-operations.html#local-operations">4.3.3</a>), and additionally want to compute terrain attributes from elevation data for observations within a study area. Before such computations we would have to acquire airborne or remotely sensed information. The corresponding imagery is often divided into scenes covering a specific spatial extent. Frequently, a study area covers more than one scene. In these cases we would like to merge the scenes covered by our study area. In the easiest case, we can just merge these scenes, that is put them side to side. This is possible with digital elevation data (SRTM, ASTER). In the following code chunk we first download the SRTM elevation data for Austria and Switzerland (for the country codes have a look at <code>ccodes()</code>). In a second step, we merge the two rasters into one.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aut =<span class="st"> </span><span class="kw">getData</span>(<span class="st">&quot;alt&quot;</span>, <span class="dt">country =</span> <span class="st">&quot;AUT&quot;</span>, <span class="dt">mask =</span> <span class="ot">TRUE</span>)
ch =<span class="st"> </span><span class="kw">getData</span>(<span class="st">&quot;alt&quot;</span>, <span class="dt">country =</span> <span class="st">&quot;CHE&quot;</span>, <span class="dt">mask =</span> <span class="ot">TRUE</span>)
aut_ch =<span class="st"> </span><span class="kw">merge</span>(aut, ch)</code></pre></div>
<p><strong>Raster</strong>’s <code>merge()</code> command combines two images, and in case they overlap, it uses the value of the first raster. You can do exactly the same with <code>gdalUtils::mosaic_rasters()</code> which is faster, and therefore recommended if you have to merge a multitude of large rasters stored on disk.</p>
<p>The merging approach is of little use when the overlapping values do not correspond to each other. This is frequently the case when you want to combine spectral imagery from scenes that were taken on different dates. The <code>merge()</code> command will still work but you will see a clear border in the resulting image. The <code>mosaic()</code> command lets you define a function for the overlapping area. For instance, we could compute the mean value. This might smooth the clear border in the merged result but it will most likely not make it disappear. To do so, we need a more advanced approach. Remote scientist frequently apply histogram matching or use regression techniques to align the values of the first image with those of the second image. The packages <strong>landsat</strong> (<code>histmatch()</code>, <code>relnorm()</code>, <code>PIF()</code>), <strong>satellite</strong> (<code>calcHistMatch()</code>) and <strong>RStoolbox</strong> (<code>histMatch()</code>, <code>pifMatch()</code>) provide the corresponding functions.</p>
</div>
<div id="aligning-rasters" class="section level3">
<h3><span class="header-section-number">4.3.8</span> Aligning rasters</h3>
<p>When merging or performing map algebra on rasters, their resolution, projection, origin and/or extent has to match. Otherwise, how should we add the values of one raster with a resolution of 0.2 decimal degrees to a second with a resolution of 1 decimal degree? The same problem arises when we would like to merge satellite imagery from different sensors with different projections and resolutions. We can deal with such mismatches by aligning the rasters.</p>
<p>The <code>projectRaster()</code> function reprojects one raster to a desired projection, say from UTM to WGS84. Equally, map algebra operations require the same extent. Following code adds one row and two columns to each side of the raster while setting all new values to an elevation of 1000 meters (<a href="spatial-data-operations.html#fig:extend-example">4.14</a>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">elev_2 =<span class="st"> </span><span class="kw">extend</span>(elev, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">value =</span> <span class="dv">1000</span>)
<span class="kw">plot</span>(elev_2)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:extend-example"></span>
<img src="figures/extend-example-1.png" alt="Original raster extended by 1 one row on each side (top, bottom) and two columns on each side (right, left)." width="576" />
<p class="caption">
Figure 4.14: Original raster extended by 1 one row on each side (top, bottom) and two columns on each side (right, left).
</p>
</div>
<p>Performing an algebraic operation on two objects with differing extents in R, the <strong>raster</strong> package returns the result for the intersection, and says so in a warning.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">elev_3 =<span class="st"> </span>elev +<span class="st"> </span>elev_2
<span class="co">#&gt; Warning in elev + elev_2: Raster objects have different extents. Result for</span>
<span class="co">#&gt; their intersection is returned</span></code></pre></div>
<p>However, we can also align the extent of two rasters with the <code>extend()</code> command. Here, we extend the <code>elev</code> object to the extend of <code>elev_2</code>. The newly added rows and column receive the default value of the <code>value</code> parameter, i.e., <code>NA</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">elev_4 =<span class="st"> </span><span class="kw">extend</span>(elev, elev_2)</code></pre></div>
<p>The <code>aggregate()</code> and <code>disaggregate()</code> functions help to change the cell size resolution of a raster. For instance, let us aggregate <code>elev</code> from a resolution of 0.5 to a resolution of 1, that means we aggregate by a factor of 2 (Fig. <a href="spatial-data-operations.html#fig:aggregate-example">4.15</a>). Additionally, the output cell value should correspond to the mean of the input cells (but one could use other functions as well such as <code>median()</code>, <code>sum()</code>, etc.):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">elev_agg =<span class="st"> </span><span class="kw">aggregate</span>(elev, <span class="dt">fact =</span> <span class="dv">2</span>, <span class="dt">fun =</span> mean)
<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
<span class="kw">plot</span>(elev)
<span class="kw">plot</span>(elev_agg)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:aggregate-example"></span>
<img src="figures/aggregate-example-1.png" alt="Original raster (left). Aggregated raster (right)." width="576" />
<p class="caption">
Figure 4.15: Original raster (left). Aggregated raster (right).
</p>
</div>
<p>Note that the origin of <code>elev_agg</code> has changed, too.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">origin</span>(elev)
<span class="co">#&gt; [1] 0 0</span>
<span class="kw">origin</span>(elev_agg)
<span class="co">#&gt; [1] 0.5 0.5</span></code></pre></div>
<p>The origin is the point closest to (0, 0) if you moved towards it in steps of x and y resolution. If two rasters have different origins, their cells do not overlap completely which would make map algebra impossible. To change the origin , use <code>origin()</code>.<a href="#fn19" class="footnoteRef" id="fnref19"><sup>19</sup></a> Looking at figure <a href="spatial-data-operations.html#fig:origin-example">4.16</a> reveals the effect of changing the origin.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># plot the aggregated raster</span>
<span class="kw">plot</span>(elev_agg)
<span class="co"># change the origin</span>
<span class="kw">origin</span>(elev_agg) =<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)
<span class="co"># plot it again</span>
<span class="kw">plot</span>(elev_agg, <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:origin-example"></span>
<img src="figures/origin-example-1.png" alt="Plotting rasters with the same values but different origins." width="576" />
<p class="caption">
Figure 4.16: Plotting rasters with the same values but different origins.
</p>
</div>
<p>The <code>resample()</code> command lets you align several raster properties in one go, namely origin, extent and resolution. Let us resample an extended <code>elev_agg</code> to the properties of <code>elev</code> again.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># add 2 rows and columns, i.e. change the extent</span>
elev_agg =<span class="st"> </span><span class="kw">extend</span>(elev_agg, <span class="dv">2</span>)
elev_disagg =<span class="st"> </span><span class="kw">resample</span>(elev_agg, elev)</code></pre></div>
<p>Though our disaggregated <code>elev_disagg</code> retrieved back its original resolution, cell size and extent, its values differ. However, this is to be expected, disaggregating <strong>cannot</strong> predict values at a finer resolution, it simply uses an interpolation algorithm. It is important to keep in mind that disaggregating results in a finer resolution, the corresponding values, however, are only as accurate as their lower resolution source.</p>
<p>Finally, if you want to align many (possibly hundreds or thousands of) images stored on disk, you might want to checkout the <code>gdalUtils::align_rasters()</code> function. Nevertheless, you may also use <strong>raster</strong> with very large datasets. This is because <strong>raster</strong>:</p>
<ol style="list-style-type: decimal">
<li>lets you work with raster datasets that are too large to fit into the main memory (RAM) by only processing chunks of it.</li>
<li>tries to fascilitate parallel processing. For more information have a look at the help pages of <code>beginCluster()</code> and <code>clusteR()</code>. Additionally, check out the <em>Multi-core functions</em> section in <code>vignette(&quot;functions&quot;, package = &quot;raster&quot;)</code>.</li>
</ol>
<!-- ## Spatial data creation -->
<!-- where should "area" example be? in this or the previous chapter? -->
<!-- Not here - I think this chapter should focus on geomtry data -->
<!-- `st_centroid()` -->
<!-- `st_buffer()` -->
<!-- http://r-spatial.org//r/2017/06/09/mapedit_0-2-0.html -->
<!-- Commented out - think this would be better in c3 (RL) -->
<!-- ```{r} -->
<!-- # add a new column -->
<!-- africa$area = set_units(st_area(africa), value = km^2) -->
<!-- africa$pop_density = africa$pop / africa$area -->
<!-- # OR -->
<!-- africa = africa %>% -->
<!--         mutate(area = set_units(st_area(.), value = km^2)) %>% -->
<!--         mutate(pop_density = pop / area) -->
<!-- ``` -->
<!-- Note that this has created a attributes for the area and population density variables: -->
<!-- ```{r} -->
<!-- attributes(africa$area) -->
<!-- attributes(africa$pop_density) -->
<!-- ``` -->
<!-- These can be set to `NULL` as follows: -->
<!-- ```{r} -->
<!-- attributes(africa$area) = NULL -->
<!-- attributes(africa$pop_density) = NULL -->
<!-- ``` -->
<!-- ## Spatial data transformation -->
<!-- changes classes; polygonize, etc-->
</div>
</div>
<div id="exercises-2" class="section level2">
<h2><span class="header-section-number">4.4</span> Exercises</h2>
<ol style="list-style-type: decimal">
<li>Write code that subsets points that are contained within <code>x</code> <em>and</em> <code>y</code> (illustrated by the plot in the 2<sup>nd</sup> row and the 1<sup>st</sup> column in Figure <a href="spatial-data-operations.html#fig:venn-clip">4.10</a>).
<ul>
<li>Create a randomly located point with the command <code>st_point()</code> (refer back to section <a href="spatial-class.html#sfg">2.1.5.2</a> to see how to create spatial data ‘from scratch’).</li>
</ul></li>
<li>Write code that uses functions <code>aggregate()</code> and <code>st_buffer()</code> to answers the following question: What proportion of the world’s population lives in countries that intersect a circle with a 10 degree radius of the intersection between the equator and the <a href="https://en.wikipedia.org/wiki/9th_meridian_east">9<sup>th</sup> meridian</a>? (Advanced challenge: find the point with the highest number of people within a 10 degree radius.)</li>
</ol>
<pre><code>#&gt; Warning in st_buffer.sfc(st_geometry(x), dist, nQuadSegs): st_buffer does
#&gt; not correctly buffer longitude/latitude data, dist needs to be in decimal
#&gt; degrees.
#&gt; although coordinates are longitude/latitude, it is assumed that they are planar
#&gt; [1] 0.00998</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Assuming that people are evenly distributed across countries, estimate the population living <em>within</em> the circle created to answer the previous question.</li>
</ol>
<pre><code>#&gt; Warning in st_interpolate_aw(x = world[&quot;pop&quot;], to = buff9, extensive =
#&gt; TRUE): st_interpolate_aw assumes attributes are constant over areas of x</code></pre>
<!-- Raster exercises-->
<ol start="4" style="list-style-type: decimal">
<li>Use <code>data(dem, package = &quot;RQGIS&quot;)</code>, and reclassify the elevation in three classes: low, middle and high. Secondly, compute the NDVI (<code>data(ndvi, package = &quot;RQGIS&quot;)</code>) and the mean elevation for each altitudinal class.</li>
<li>Apply a line detection filter to <code>data(dem, package = &quot;RQGIS&quot;)</code>.</li>
<li>Calculate the NDVI of a Landsat image. Use the Landsat image provided by the <strong>spDataLarge</strong> package (<code>system.file(&quot;raster/landsat.tif&quot;, package=&quot;spDataLarge&quot;)</code>).</li>
<li>This <a href="https://stackoverflow.com/questions/35555709/global-raster-of-geographic-distances">post</a> shows how to compute distances to the nearest coastline using <code>raster::distance()</code>. Retrieve a digital elevation model of Spain, and compute a raster which represents the distance to the coast. (Hint: Have a look at <code>getData()</code> to retrieve a digital elevation model and administrative boundaries for Spain.) Before, computing the distance raster, you might want to increase the resolution of the input dem raster, otherwise computing time might become too long. Secondly, weight the distance raster with elevation. Every 100 altitudinal meters should increase the distance to the coast by 10 km. Finally, compute the difference between the raster using the euclidean distance and the raster weighted by elevation. (Note that this is a very simple weighting approach. A more advanced approach might instead weight by flow direction, i.e. favor the steepest drop or the slightest increase in elevation.)</li>
</ol>

</div>
</div>
<h3> References</h3>
<div id="refs" class="references">
<div id="ref-qiu_development_2012">
<p>Qiu, Fang, Caiyun Zhang, and Yuhong Zhou. 2012. “The Development of an Areal Interpolation ArcGIS Extension and a Comparative Study.” <em>GIScience &amp; Remote Sensing</em> 49 (5): 644–63. doi:<a href="https://doi.org/10.2747/1548-1603.49.5.644">10.2747/1548-1603.49.5.644</a>.</p>
</div>
<div id="ref-tobler_smooth_1979">
<p>Tobler, Waldo R. 1979. “Smooth Pycnophylactic Interpolation for Geographical Regions.” <em>Journal of the American Statistical Association</em> 74 (367): 519–30. doi:<a href="https://doi.org/10.1080/01621459.1979.10481647">10.1080/01621459.1979.10481647</a>.</p>
</div>
<div id="ref-grolemund_r_2016">
<p>Grolemund, Garrett, and Hadley Wickham. 2016. <em>R for Data Science</em>. 1 edition. O’Reilly Media.</p>
</div>
<div id="ref-tomlin_geographic_1990">
<p>Tomlin, C. Dana. 1990. <em>Geographic Information Systems and Cartographic Modeling</em>. Englewood Cliffs, N.J: Prentice Hall.</p>
</div>
<div id="ref-muenchow_predictive_2013">
<p>Muenchow, Jannes, Achim Bräuning, Eric Frank Rodríguez, and Henrik von Wehrden. 2013. “Predictive Mapping of Species Richness and Plant Species’ Distributions of a Peruvian Fog Oasis Along an Altitudinal Gradient.” <em>Biotropica</em> 45 (5): 557–66. doi:<a href="https://doi.org/10.1111/btp.12049">10.1111/btp.12049</a>.</p>
</div>
<div id="ref-burrough_principles_2015">
<p>Burrough, P. A., Rachael McDonnell, and Christopher D. Lloyd. 2015. <em>Principles of Geographical Information Systems</em>. Third edition. Oxford ; New York: Oxford University Press.</p>
</div>
<div id="ref-liu_essential_2009">
<p>Liu, Jian-Guo, and Philippa J. Mason. 2009. <em>Essential Image Processing and GIS for Remote Sensing</em>. Chichester, West Sussex, UK ; Hoboken, NJ: Wiley-Blackwell.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="18">
<li id="fn18"><p>Recall attribute subsetting can also be done in base R with <code>africa_wgs = world[world$continent == &quot;Africa&quot;, ]</code>.<a href="spatial-data-operations.html#fnref18">↩</a></p></li>
<li id="fn19"><p>If the origins of two raster datasets are just marginally apart, it sometimes is sufficient to simply increase the <code>tolerance</code> argument of <code>raster::rasterOptions()</code>.<a href="spatial-data-operations.html#fnref19">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="attr.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="read-write.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Robinlovelace/geocompr/edit/master/04-spatial-operations.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
